const initial = [
  { Plancher: "Terrasse", Niv: 0, Gi: 12, Qi: 10 },
  { Plancher: "PH 4ème", Niv: 1, Gi: 10, Qi: 8 },
  { Plancher: "PH 3ème", Niv: 2, Gi: 10, Qi: 5.3 },
  { Plancher: "PH 2ème", Niv: 3, Gi: 10, Qi: 4.7 },
  { Plancher: "PH 1er", Niv: 4, Gi: 10, Qi: 4.1 },
  { Plancher: "PH RDC", Niv: 5, Gi: 10, Qi: 3.5 },
];

let rows = JSON.parse(JSON.stringify(initial));
const tbody = document.querySelector('#tbl tbody');
const scaleToggle = document.getElementById('scaleToggle');

function toNum(v) {
  const n = parseFloat(String(v).replace(',', '.'));
  return isFinite(n) ? n : 0;
}

function recompute() {
  let sG = 0, sQ = 0;
  const alpha_n = 0.8; // Load reduction factor for 6 floors
  for (const r of rows) {
    sG += toNum(r.Gi);
    sQ += toNum(r.Qi);
    r.sumGi = sG;
    r.sumQi = sQ;
    r.Nu = 1.35 * r.sumGi + 1.5 * (alpha_n * r.sumQi);
    r.Ns = r.sumGi + (alpha_n * r.sumQi);
  }
}

function render() {
  recompute();
  tbody.innerHTML = '';
  rows.forEach((r, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.Plancher}</td>
      <td>${r.Niv}</td>
      <td contenteditable="true" data-idx="${idx}" data-field="Gi">${r.Gi}</td>
      <td>${(r.sumGi).toFixed(2)}</td>
      <td contenteditable="true" data-idx="${idx}" data-field="Qi">${r.Qi}</td>
      <td>${(r.sumQi).toFixed(2)}</td>
      <td>${(r.Nu).toFixed(2)}</td>
      <td>${(r.Ns).toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
  bindEditing();
}

function bindEditing() {
  tbody.querySelectorAll('td[contenteditable="true"]').forEach(td => {
    td.addEventListener('blur', () => {
      const idx = +td.dataset.idx;
      const field = td.dataset.field;
      rows[idx][field] = toNum(td.textContent);
      render();
    });
    td.addEventListener('keydown', e => {
      if (e.key === "Enter") { e.preventDefault(); td.blur(); }
    });
  });
}

document.getElementById('reset').addEventListener('click', () => {
  rows = JSON.parse(JSON.stringify(initial));
  render();
});

scaleToggle.addEventListener('change', render); // Note: Checkbox is now redundant but kept for compatibility

document.getElementById('downloadCsv').addEventListener('click', () => {
  recompute();
  const header = ['Plancher','Niv','Gi','∑Gi','Qi','∑Qi','Nu','Ns'];
  const lines = [header.join(',')];
  rows.forEach(r => {
    lines.push([
      r.Plancher, r.Niv, r.Gi, r.sumGi.toFixed(2), r.Qi, r.sumQi.toFixed(2), r.Nu.toFixed(2), r.Ns.toFixed(2)
    ].join(','));
  });
  const blob = new Blob([lines.join('\n')], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'descente_de_charge.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

render();

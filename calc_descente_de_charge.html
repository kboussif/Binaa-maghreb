<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Column Load Transfer Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            direction: ltr; /* Default LTR */
        }
        body.rtl {
            direction: rtl; /* RTL for Darija */
            text-align: right;
        }
        h1 {
            text-align: center;
            color: #333;
            font-size: 1.8em;
        }
        table {
            width: 100%;
            max-width: 800px;
            border-collapse: collapse;
            margin: 20px auto;
            background-color: #fff;
            font-size: 1em;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .rtl th, .rtl td {
            text-align: center; /* Keep center alignment for numbers in RTL */
        }
        th {
            background-color: #4CAF50;
            color: white;
            font-size: 1.1em;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        input {
            width: 60px;
            padding: 6px;
            text-align: center;
            font-size: 0.9em;
        }
        .rtl input {
            text-align: center; /* Center numbers in inputs for RTL */
        }
        input.invalid {
            border: 2px solid red;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            display: inline-block;
            margin: 10px 5px;
            font-size: 0.9em;
        }
        button:hover {
            background-color: #45a049;
        }
        #results {
            margin-top: 20px;
            padding: 12px;
            background-color: #e8f5e9;
            border-radius: 5px;
            text-align: left;
            font-size: 0.9em;
        }
        .rtl #results {
            text-align: right; /* RTL for results */
        }
        .label {
            font-weight: bold;
        }
        .info-box {
            background-color: #f0f8ff;
            border: 2px solid #4a90e2;
            padding: 12px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            color: #333;
            max-width: 600px;
            line-height: 1.5;
            margin: 20px auto;
            text-align: center;
            font-size: 0.9em;
        }
        .rtl .info-box {
            text-align: right; /* RTL for info-box */
        }
        canvas {
            width: 100% !important;
            max-width: 800px;
            height: 400px !important;
            margin: 20px auto;
            background: #fff;
            padding: 10px;
            border-radius: 5px;
        }
        /* Media query for mobile devices */
        @media screen and (max-width: 600px) {
            table {
                font-size: 0.8em;
            }
            th, td {
                padding: 6px;
            }
            input {
                width: 50px;
                font-size: 0.8em;
            }
            canvas {
                max-width: 100%;
                height: 300px !important;
            }
            h1 {
                font-size: 1.4em;
            }
            button {
                padding: 6px 12px;
                font-size: 0.8em;
            }
            .info-box, #results {
                font-size: 0.8em;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>
    <h1 id="title">Column Load Transfer Calculator</h1>
    <div class="info-box">
        <p id="info-text">Enter the permanent (G0) and variable (Q0) loads for each floor (Level 0 to 5, from Terrace to Ground Floor) to calculate column loads. Levels are fixed (0 to 5). Calculations update automatically.</p>
        <p>ðŸ’¡ Tip: For better table display, use a computer or rotate your phone to landscape mode.</p>
        <button onclick="toggleLanguage()" aria-label="Switch Language">Switch to French</button>
    </div>

    <table id="tbl">
        <thead>
            <tr>
                <th id="th-floor">Floor</th>
                <th id="th-level">Level</th>
                <th id="th-g0">Permanent Load (t)</th>
                <th id="th-sum-g0">Cumulative G0 (t)</th>
                <th id="th-q0">Variable Load (t)</th>
                <th id="th-sum-q0">Cumulative Q0 (t)</th>
                <th id="th-nu">Ultimate Load (t)</th>
                <th id="th-ns">Service Load (t)</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td id="floor-0">Terrace</td>
                <td>0</td>
                <td><input type="number" data-idx="0" data-field="G0" value="12" min="0" step="0.01" aria-label="Permanent Load Terrace"></td>
                <td></td>
                <td><input type="number" data-idx="0" data-field="Q0" value="10" min="0" step="0.01" aria-label="Variable Load Terrace"></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td id="floor-1">4th Floor</td>
                <td>1</td>
                <td><input type="number" data-idx="1" data-field="G0" value="10" min="0" step="0.01" aria-label="Permanent Load 4th Floor"></td>
                <td></td>
                <td><input type="number" data-idx="1" data-field="Q0" value="8" min="0" step="0.01" aria-label="Variable Load 4th Floor"></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td id="floor-2">3rd Floor</td>
                <td>2</td>
                <td><input type="number" data-idx="2" data-field="G0" value="10" min="0" step="0.01" aria-label="Permanent Load 3rd Floor"></td>
                <td></td>
                <td><input type="number" data-idx="2" data-field="Q0" value="6" min="0" step="0.01" aria-label="Variable Load 3rd Floor"></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td id="floor-3">2nd Floor</td>
                <td>3</td>
                <td><input type="number" data-idx="3" data-field="G0" value="10" min="0" step="0.01" aria-label="Permanent Load 2nd Floor"></td>
                <td></td>
                <td><input type="number" data-idx="3" data-field="Q0" value="6" min="0" step="0.01" aria-label="Variable Load 2nd Floor"></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td id="floor-4">1st Floor</td>
                <td>4</td>
                <td><input type="number" data-idx="4" data-field="G0" value="10" min="0" step="0.01" aria-label="Permanent Load 1st Floor"></td>
                <td></td>
                <td><input type="number" data-idx="4" data-field="Q0" value="6" min="0" step="0.01" aria-label="Variable Load 1st Floor"></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td id="floor-5">Ground Floor</td>
                <td>5</td>
                <td><input type="number" data-idx="5" data-field="G0" value="10" min="0" step="0.01" aria-label="Permanent Load Ground Floor"></td>
                <td></td>
                <td><input type="number" data-idx="5" data-field="Q0" value="6" min="0" step="0.01" aria-label="Variable Load Ground Floor"></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </tbody>
    </table>

    <button onclick="calculateLoads()" aria-label="Calculate Loads">Calculate Loads</button>
    <button onclick="resetTable()" aria-label="Reset">Reset</button>
    <button onclick="downloadCsv()" aria-label="Download CSV">Download CSV</button>

    <div id="results"></div>
    <canvas id="loadChart"></canvas>

    <script>
        // Initial data for floors
        const initial = [
            { floor: { en: "Terrace", fr: "Terrasse", ma: "Ø§Ù„Ø³Ø·Ø­" }, level: 0, G0: 12, Q0: 10 },
            { floor: { en: "4th Floor", fr: "PH 4Ã¨me", ma: "Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø±Ø§Ø¨Ø¹" }, level: 1, G0: 10, Q0: 8 },
            { floor: { en: "3rd Floor", fr: "PH 3Ã¨me", ma: "Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù„Ø«" }, level: 2, G0: 10, Q0: 6 },
            { floor: { en: "2nd Floor", fr: "PH 2Ã¨me", ma: "Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ" }, level: 3, G0: 10, Q0: 6 },
            { floor: { en: "1st Floor", fr: "PH 1er", ma: "Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" }, level: 4, G0: 10, Q0: 6 },
            { floor: { en: "Ground Floor", fr: "PH RDC", ma: "Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" }, level: 5, G0: 10, Q0: 6 },
        ];

        let rows = JSON.parse(JSON.stringify(initial));
        let chart = null;
        let language = "en";

        // Translations for English, French, and Moroccan Darija
        const translations = {
            en: {
                title: "Column Load Transfer Calculator",
                infoText: "Enter the permanent (G0) and variable (Q0) loads for each floor (Level 0 to 5, from Terrace to Ground Floor) to calculate column loads. Levels are fixed (0 to 5). Calculations update automatically.",
                floor: "Floor",
                level: "Level",
                g0: "Permanent Load (t)",
                sumG0: "Cumulative G0 (t)",
                q0: "Variable Load (t)",
                sumQ0: "Cumulative Q0 (t)",
                nu: "Ultimate Load (t)",
                ns: "Service Load (t)",
                results: "Results",
                calculate: "Calculate Loads",
                reset: "Reset",
                download: "Download CSV",
                switchLang: "Switch to French",
                invalidInput: "Please enter a valid non-negative number."
            },
            fr: {
                title: "Calculatrice de descente de charge sur poteau",
                infoText: "Entrez les charges permanentes (G0) et variables (Q0) pour chaque Ã©tage (Niv 0 Ã  5, de la Terrasse au RDC) pour calculer les charges sur un poteau. Les niveaux sont fixes (0 Ã  5). Les calculs se mettent Ã  jour automatiquement.",
                floor: "Plancher",
                level: "Niv",
                g0: "Charge permanente (t)",
                sumG0: "âˆ‘G0 (t)",
                q0: "Charge variable (t)",
                sumQ0: "âˆ‘Q0 (t)",
                nu: "Charge ultime (t)",
                ns: "Charge de service (t)",
                results: "RÃ©sultats",
                calculate: "Calculer les charges",
                reset: "RÃ©initialiser",
                download: "TÃ©lÃ©charger CSV",
                switchLang: "Passer Ã  l'anglais",
                invalidInput: "Veuillez entrer un nombre valide et non nÃ©gatif."
            },
            ma: {
                title: "Ø­Ø§Ø³Ø¨Ø© Ù†Ù‚Ù„ Ø§Ù„Ø­Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙˆØ¯",
                infoText: "Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙˆØ¬ Ø§Ù„Ø«Ø§Ø¨Øª (G0) ÙˆØ§Ù„Ø¨ÙˆØ¬ Ø§Ù„Ù…ØªØºÙŠØ± (Q0) Ù„ÙƒÙ„ Ø·Ø§Ø¨Ù‚ (Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 0 Ù„Ù„Ø³Ø·Ø­ ØªØ§ Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ 5) Ø¨Ø§Ø´ ØªØ­Ø³Ø¨ Ø§Ù„Ø­Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙˆØ¯. Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø«Ø§Ø¨ØªØ© (0 ØªØ§ 5). Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙƒØªØªØ­Ø¯Ø« Ø£ØªÙˆÙ…Ø§ØªÙŠÙƒÙŠ.",
                floor: "Ø§Ù„Ø·Ø§Ø¨Ù‚",
                level: "Ø§Ù„Ù…Ø³ØªÙˆÙ‰",
                g0: "Ø§Ù„Ø¨ÙˆØ¬ Ø§Ù„Ø«Ø§Ø¨Øª (Ø·Ù†)",
                sumG0: "Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¨ÙˆØ¬ Ø§Ù„Ø«Ø§Ø¨Øª (Ø·Ù†)",
                q0: "Ø§Ù„Ø¨ÙˆØ¬ Ø§Ù„Ù…ØªØºÙŠØ± (Ø·Ù†)",
                sumQ0: "Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¨ÙˆØ¬ Ø§Ù„Ù…ØªØºÙŠØ± (Ø·Ù†)",
                nu: "Ø§Ù„Ø­Ù…Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø·Ù†)",
                ns: "Ø§Ù„Ø­Ù…Ù„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Ø·Ù†)",
                results: "Ø§Ù„Ù†ØªØ§Ø¦Ø¬",
                calculate: "Ø­Ø³Ø¨",
                reset: "Ø±Ø¬Ø¹ Ù„Ù„Ø£ØµÙ„",
                download: "Ù†Ø²Ù„ CSV",
                switchLang: "Ø¨Ø¯Ù„ Ù„Ù„Ø¯Ø§Ø±Ø¬Ø©",
                invalidInput: "Ø¯Ø®Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ ÙˆÙ…Ø§ ÙŠÙƒÙˆÙ†Ø´ Ù†Ø§Ù‚Øµ."
            }
        };

        // Convert input to number, handle invalid/negative values
        function toNum(v) {
            const n = parseFloat(String(v).replace(',', '.'));
            return isFinite(n) && n >= 0 ? n : NaN;
        }

        // Calculate cumulative loads according to table formulas
        function recompute() {
            let sumG0 = 0;
            const Q = rows.map(r => toNum(r.Q0));
            rows.forEach((r, idx) => {
                sumG0 += toNum(r.G0);
                r.sumG0 = sumG0;

                if (idx === 0) {
                    r.sumQ0 = Q[0];
                } else if (idx === 1) {
                    r.sumQ0 = Q[0] + Q[1];
                } else if (idx === 2) {
                    r.sumQ0 = 0.95 * (Q[1] + Q[2]) + Q[0];
                } else if (idx === 3) {
                    r.sumQ0 = 0.9 * (Q[1] + Q[2] + Q[3]) + Q[0];
                } else if (idx === 4) {
                    r.sumQ0 = 0.85 * (Q[1] + Q[2] + Q[3] + Q[4]) + Q[0];
                } else if (idx === 5) {
                    r.sumQ0 = 0.8 * (Q[1] + Q[2] + Q[3] + Q[4] + Q[5]) + Q[0];
                }

                r.Nu = 1.35 * r.sumG0 + 1.5 * r.sumQ0;
                r.Ns = r.sumG0 + r.sumQ0;
            });
        }

        // Render table and results
        function render() {
            console.log("Rendering table...");
            recompute();
            const tbody = document.querySelector('#tbl tbody');
            let hasInvalidInput = false;
            tbody.querySelectorAll('input').forEach(input => {
                const idx = +input.dataset.idx;
                const field = input.dataset.field;
                input.value = rows[idx][field];
                input.classList.remove('invalid');
                if (isNaN(toNum(input.value))) {
                    input.classList.add('invalid');
                    hasInvalidInput = true;
                }
            });
            const cells = tbody.querySelectorAll('td:not(:nth-child(1)):not(:nth-child(2)):not(:nth-child(3)):not(:nth-child(5))');
            cells.forEach((td, index) => {
                const rowIndex = Math.floor(index / 4);
                const colIndex = index % 4;
                if (colIndex === 0) td.textContent = rows[rowIndex].sumG0.toFixed(2);
                if (colIndex === 1) td.textContent = rows[rowIndex].sumQ0.toFixed(2);
                if (colIndex === 2) td.textContent = rows[rowIndex].Nu.toFixed(2);
                if (colIndex === 3) td.textContent = rows[rowIndex].Ns.toFixed(2);
            });
            updateResults();
            updateChart();
            if (hasInvalidInput) {
                alert(translations[language].invalidInput);
            }
        }

        // Update language-specific elements
        function updateLanguage() {
            document.getElementById('title').textContent = translations[language].title;
            document.getElementById('info-text').textContent = translations[language].infoText;
            document.getElementById('th-floor').textContent = translations[language].floor;
            document.getElementById('th-level').textContent = translations[language].level;
            document.getElementById('th-g0').textContent = translations[language].g0;
            document.getElementById('th-sum-g0').textContent = translations[language].sumG0;
            document.getElementById('th-q0').textContent = translations[language].q0;
            document.getElementById('th-sum-q0').textContent = translations[language].sumQ0;
            document.getElementById('th-nu').textContent = translations[language].nu;
            document.getElementById('th-ns').textContent = translations[language].ns;

            const calcBtn = document.querySelector('button[onclick="calculateLoads()"]');
            calcBtn.textContent = translations[language].calculate;
            calcBtn.setAttribute('aria-label', translations[language].calculate);

            const resetBtn = document.querySelector('button[onclick="resetTable()"]');
            resetBtn.textContent = translations[language].reset;
            resetBtn.setAttribute('aria-label', translations[language].reset);

            const downloadBtn = document.querySelector('button[onclick="downloadCsv()"]');
            downloadBtn.textContent = translations[language].download;
            downloadBtn.setAttribute('aria-label', translations[language].download);

            const switchBtn = document.querySelector('button[onclick="toggleLanguage()"]');
            switchBtn.textContent = translations[language].switchLang;
            switchBtn.setAttribute('aria-label', translations[language].switchLang);

            for (let i = 0; i < 6; i++) {
                document.getElementById(`floor-${i}`).textContent = initial[i].floor[language];
            }

            // Toggle RTL for Darija
            document.body.classList.toggle('rtl', language === 'ma');
        }

        function toggleLanguage() {
            if (language === 'en') {
                language = 'fr';
            } else if (language === 'fr') {
                language = 'ma';
            } else {
                language = 'en';
            }
            updateLanguage();
            render();
        }

        function calculateLoads() {
            render();
        }

        function resetTable() {
            rows = JSON.parse(JSON.stringify(initial));
            render();
        }

        function downloadCsv() {
            let csv = `${translations[language].floor},${translations[language].level},${translations[language].g0},${translations[language].sumG0},${translations[language].q0},${translations[language].sumQ0},${translations[language].nu},${translations[language].ns}\n`;
            rows.forEach(r => {
                csv += `${r.floor[language]},${r.level},${r.G0},${r.sumG0.toFixed(2)},${r.Q0},${r.sumQ0.toFixed(2)},${r.Nu.toFixed(2)},${r.Ns.toFixed(2)}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'column_loads.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function updateResults() {
            const maxNu = Math.max(...rows.map(r => r.Nu));
            const maxNs = Math.max(...rows.map(r => r.Ns));
            const maxNuFloor = rows.find(r => r.Nu === maxNu).floor[language];
            const maxNsFloor = rows.find(r => r.Ns === maxNs).floor[language];
            document.getElementById('results').innerHTML = `
                <p class="label">${translations[language].results}:</p>
                <p>Maximum Ultimate Load (Nu): ${maxNu.toFixed(2)} t (at ${maxNuFloor})</p>
                <p>Maximum Service Load (Ns): ${maxNs.toFixed(2)} t (at ${maxNsFloor})</p>
            `;
        }

        function updateChart() {
            const ctx = document.getElementById('loadChart').getContext('2d');
            const labels = rows.map(r => `${r.floor[language]} (Level ${r.level})`);
            const dataNu = rows.map(r => r.Nu);
            const dataNs = rows.map(r => r.Ns);
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: translations[language].nu,
                            data: dataNu,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: translations[language].ns,
                            data: dataNs,
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: translations[language].nu.includes('Ultimate') ? "Load (t)" : "Ø§Ù„Ø­Ù…Ù„ (Ø·Ù†)",
                                font: {
                                    size: 14
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: translations[language].floor,
                                font: {
                                    size: 14
                                }
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    maintainAspectRatio: false
                }
            });
        }

        // Add auto-update on input change
        document.querySelectorAll('#tbl input').forEach(input => {
            input.addEventListener('input', () => {
                const idx = +input.dataset.idx;
                const field = input.dataset.field;
                rows[idx][field] = input.value;
                render();
            });
        });

        // Initial render
        updateLanguage();
        render();
    </script>
</body>
</html>

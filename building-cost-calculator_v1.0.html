<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ø­Ø§Ø³Ø¨Ø© ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ù†Ø§Ø¡ - Ù†Ø³Ø®Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©</title>

<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  body { font-family: 'Amiri', 'Noto Sans Arabic', sans-serif; background: #f4e7d3; color: #3c2f2f; padding: 20px; }
  .container { max-width: 1200px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; }
  h1, h2, h3 { color: #004aad; }
  input, button, select { padding: 6px; margin: 4px; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { border: 1px solid #d4a373; padding: 8px; text-align: center; }
  .admin-panel { background: #ede7f6; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: none; }
  .toggle-admin { background: #004aad; color: white; padding: 8px; border: none; cursor: pointer; margin:8px 0; }
  .admin-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .admin-row input, .admin-row select { min-width:140px; }
  .admin-block { margin-bottom:10px; }
  .small { width:120px; }
  .hidden { display:none; }
</style>
</head>
<body>
<div class="container">
  <h1>Ø­Ø§Ø³Ø¨Ø© ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ù†Ø§Ø¡ - Ù†Ø³Ø®Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©</h1>

  <!-- Project Inputs -->
  <div>
    <label>Ø·ÙˆÙ„ Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ù…):</label><input type="number" id="buildLength" value="10">
    <label>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ù…):</label><input type="number" id="buildWidth" value="10">
    <div style="display:none;">
      <label>Ø·ÙˆÙ„ Ø§Ù„Ø£Ø±Ø¶ (Ù…):</label><input type="number" id="landLength" value="10">
      <label>Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø¶ (Ù…):</label><input type="number" id="landWidth" value="10">
    </div>
    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚:</label><input type="number" id="numFloors" value="3" min="1">
    <label>ÙˆØ¬ÙˆØ¯ Ù‚Ø¨Ùˆ:</label><input type="checkbox" id="hasBasement">
    <button onclick="calculateCost()">Ø§Ø­Ø³Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ©</button>
  </div>

  <!-- Toggle Admin Tools -->
  <button class="toggle-admin" onclick="document.querySelector('.admin-panel').style.display =
      document.querySelector('.admin-panel').style.display==='none' ? 'block' : 'none'">
    âš™ï¸ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
  </button>

  

<!-- Admin Panel -->
<div class="admin-panel">
  <h3>Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>

  <!-- Add Section -->
  <div class="admin-block admin-row">
    <label for="newSectionName" style="margin-left:8px;">Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:</label>
    <input id="newSectionName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
    <button onclick="addSection()">â• Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</button>
  </div>

  <!-- Rename / Delete Section -->
  <div class="admin-block admin-row">
    <label for="sectionSelect" style="margin-left:8px;">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…:</label>
    <select id="sectionSelect" class="small"></select>

    <label for="renameSectionName" style="margin-left:8px;">Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù‚Ø³Ù…:</label>
    <input id="renameSectionName" placeholder="Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù‚Ø³Ù…">
    <button onclick="renameSection()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…</button>
    <button onclick="deleteSection()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…</button>
  </div>

  <!-- Items Management -->
  <div class="admin-block">
    <div class="admin-row">
      <label for="sectionForItem" style="margin-left:8px;">Ø§Ù„Ù‚Ø³Ù…:</label>
      <select id="sectionForItem" class="small"></select>

      <label for="itemList" style="margin-left:8px;">Ø§Ù„Ø¨Ù†Ø¯:</label>
      <select id="itemList" class="small"></select>
    </div>

    <div class="admin-row" style="margin-top:8px;">
      <label for="itemName" style="margin-left:8px;">Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯:</label>
      <input id="itemName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯" style="flex:1;">

      <label for="itemUnit" style="margin-left:8px;">Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
      <input id="itemUnit" placeholder="Ø§Ù„ÙˆØ­Ø¯Ø© (Ù…Ø«Ø§Ù„: 1 Ø£Ùˆ 100)" class="small">

      <label for="itemPrice" style="margin-left:8px;">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
      <input type="number" id="itemPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©" class="small">

      <label for="itemQty" style="margin-left:8px;">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:</label>
      <input type="number" id="itemQty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©" class="small">
    </div>

    <div class="admin-row" style="margin-top:8px;">
      <button onclick="addItem()">â• Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</button>
      <button onclick="updateItem()">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
      <button onclick="deleteItem()">ğŸ—‘ï¸ Ø­Ø°Ù</button>
   </div>
  </div>

<!--	  <label style="margin-right:8px;">  <input type="checkbox" id="itemIgnoreFloors" checked> ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚</label> -->
 


  <!-- Export / Import -->
  <div class="admin-block admin-row">
    <button onclick="exportModel()">ğŸ’¾ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (JSON)</button>
    <input type="file" id="importFile" onchange="importModel(event)">
  </div>
</div>




  <!-- Cost Output -->
  <div id="costOutput"></div>

  <!-- Export Buttons -->
  <div style="margin-top:8px;">
    <button onclick="exportToPDF()">ğŸ“„ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF</button>
	<button onclick="exportCostEstimation()">ğŸ“Š ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
  </div>
</div>



<

<script>
/* ---------- Config & state ---------- */
const LOG_ENABLED = true;
let baseData = [];                  // main model
let lastSectionIdx = null;          // index numbers (strings from select) tracked
let lastItemIdx = null;

/* ---------- Fallback default model (used if fetch fails) ---------- */
const fallbackModel = [
  {
    name: "Ø§Ù„Ø£Ø³Ø§Ø³Ø§Øª",
    items: [
      { item: "Ø­ÙØ± Ø§Ù„Ø£Ø³Ø§Ø³Ø§Øª", unit: "1", unitPrice: 30, baseQty: 1, ignoreFloors: true },
      { item: "Ø§Ù„Ø¨ÙŠØ·ÙˆÙ† (B25)", unit: "100", unitPrice: 780, baseQty: 25 }
    ]
  },
  {
    name: "Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡Ø§Øª",
    items: [
      { item: "Ø§Ù„ÙŠØ§Ø¬ÙˆØ± (15)", unit: "100", unitPrice: 5.5, baseQty: 1500 },
      { item: "Ø§Ù„Ø±Ù…Ù„", unit: "100", unitPrice: 4, baseQty: 350 }
    ]
  }
];

/* ---------- Load default model ---------- */
async function loadDefaultData() {
  try {
    const url = 'https://raw.githubusercontent.com/kboussif/Binaa-maghreb/main/Binaa_mabgreb_defaultDataV1.json';
    const res = await fetch(url);
    if (!res.ok) throw new Error('Failed to fetch remote JSON, using fallback');
    baseData = await res.json();
    if (!Array.isArray(baseData) || baseData.length === 0) throw new Error('Invalid JSON, using fallback');
    console.log('Loaded model from GitHub');
  } catch (err) {
    console.warn(err);
    baseData = JSON.parse(JSON.stringify(fallbackModel)); // deep copy
    console.log('Using fallback model');
  }

  refreshSectionSelects();
  // initialize selection defaults
  const secSel = document.getElementById('sectionForItem');
  if (secSel.options.length > 0) secSel.selectedIndex = 0;
  populateItemList();

  // set last selection
  lastSectionIdx = secSel.value || null;
  const itSel = document.getElementById('itemList');
  if (itSel.options.length > 0) itSel.selectedIndex = 0;
  lastItemIdx = itSel.value || null;
  loadItemDetails(); // fill form with first item
  calculateCost();
}

/* ---------- UI population ---------- */
function refreshSectionSelects() {
  const selects = [document.getElementById('sectionSelect'), document.getElementById('sectionForItem')];
  selects.forEach(sel => {
    sel.innerHTML = '';
    baseData.forEach((sec, idx) => {
      const opt = document.createElement('option');
      opt.value = idx;
      opt.textContent = sec.name;
      sel.appendChild(opt);
    });
  });
}

function populateItemList() {
  const sectionIdx = Number(document.getElementById('sectionForItem').value || 0);
  const itemList = document.getElementById('itemList');
  itemList.innerHTML = '';
  if (!baseData[sectionIdx] || !Array.isArray(baseData[sectionIdx].items)) return;
  baseData[sectionIdx].items.forEach((it, idx) => {
    const opt = document.createElement('option');
    opt.value = idx;
    opt.textContent = it.item || `Ø¨Ù†Ø¯ ${idx+1}`;
    itemList.appendChild(opt);
  });
}

/* ---------- Helpers to autosave pending edits ---------- */
function getCurrentFormValues() {
  return {
    item: document.getElementById('itemName').value || '',
    unit: document.getElementById('itemUnit').value || '',
    unitPrice: parseFloat(document.getElementById('itemPrice').value) || 0,
    baseQty: parseFloat(document.getElementById('itemQty').value) || 0,
//    ignoreFloors: !!document.getElementById('itemIgnoreFloors').checked
  };
}

function savePendingEditsIfAny(oldSecIdx, oldItIdx) {
  if (oldSecIdx == null || oldItIdx == null) return;
  oldSecIdx = Number(oldSecIdx);
  oldItIdx = Number(oldItIdx);
  if (!baseData[oldSecIdx] || !baseData[oldSecIdx].items[oldItIdx]) return;

  const current = baseData[oldSecIdx].items[oldItIdx];
  const form = getCurrentFormValues();

  // Compare: if different, update silently (auto-save)
  const changed = current.item !== form.item ||
                  String(current.unit) !== String(form.unit) ||
                  Number(current.unitPrice) !== Number(form.unitPrice) ||
                  Number(current.baseQty) !== Number(form.baseQty) ||
                  Boolean(current.ignoreFloors) !== Boolean(form.ignoreFloors);

  if (changed) {
    baseData[oldSecIdx].items[oldItIdx] = {
      item: form.item,
      unit: form.unit,
      unitPrice: form.unitPrice,
      baseQty: form.baseQty,
      ignoreFloors: form.ignoreFloors
    };
    logRow(`Auto-saved edits for section ${oldSecIdx}, item ${oldItIdx}`);
    // update list text
    populateItemList();
    // restore the selection index (it may change after re-populate)
    document.getElementById('itemList').value = String(oldItIdx);
    calculateCost();
  }
}

/* ---------- Load item details into the edit form ---------- */
function loadItemDetails() {
  const sectionIdx = Number(document.getElementById('sectionForItem').value || 0);
  const itemIdx = Number(document.getElementById('itemList').value || 0);

  // Auto-save previous edits
  if (lastSectionIdx !== null || lastItemIdx !== null) {
    // if selection actually changed, save old first
    if (String(sectionIdx) !== String(lastSectionIdx) || String(itemIdx) !== String(lastItemIdx)) {
      savePendingEditsIfAny(lastSectionIdx, lastItemIdx);
    }
  }

  lastSectionIdx = sectionIdx;
  lastItemIdx = itemIdx;

  if (!baseData[sectionIdx] || !baseData[sectionIdx].items[itemIdx]) {
    // clear form
    document.getElementById('itemName').value = '';
    document.getElementById('itemUnit').value = '';
    document.getElementById('itemPrice').value = '';
    document.getElementById('itemQty').value = '';
//    document.getElementById('itemIgnoreFloors').checked = true;
    return;
  }

  const it = baseData[sectionIdx].items[itemIdx];
  document.getElementById('itemName').value = it.item || '';
  document.getElementById('itemUnit').value = it.unit || '';
  document.getElementById('itemPrice').value = it.unitPrice != null ? it.unitPrice : '';
  document.getElementById('itemQty').value = it.baseQty != null ? it.baseQty : '';
//  document.getElementById('itemIgnoreFloors').checked = !!it.ignoreFloors;
}

/* ---------- CRUD operations ---------- */
function addSection() {
  const name = (document.getElementById('newSectionName').value || '').trim();
  if (!name) { alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…'); return; }
  baseData.push({ name, items: [] });
  refreshSectionSelects();
  // select newly added
  const secSel = document.getElementById('sectionForItem');
  secSel.value = String(baseData.length - 1);
  populateItemList();
  lastSectionIdx = secSel.value;
  lastItemIdx = null;
  calculateCost();
}

function renameSection() {
  const idx = Number(document.getElementById('sectionSelect').value);
  const name = (document.getElementById('renameSectionName').value || '').trim();
  if (!baseData[idx]) return;
  if (!name) { alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯'); return; }
  baseData[idx].name = name;
  refreshSectionSelects();
  populateItemList();
  calculateCost();
}

function deleteSection() {
  const idx = Number(document.getElementById('sectionSelect').value);
  if (!baseData[idx]) return;
  if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…ØŸ')) return;
  baseData.splice(idx, 1);
  refreshSectionSelects();
  populateItemList();
  calculateCost();
}

function addItem() {
  const secIdx = Number(document.getElementById('sectionForItem').value || 0);
  if (!baseData[secIdx]) { alert('Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹'); return; }
  const newItem = getCurrentFormValues();
  if (!newItem.item) { alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯'); return; }
  baseData[secIdx].items.push(newItem);
  populateItemList();
  // select the newly added item
  document.getElementById('itemList').value = String(baseData[secIdx].items.length - 1);
  lastSectionIdx = secIdx;
  lastItemIdx = document.getElementById('itemList').value;
  calculateCost();
}

function updateItem() {
  let sectionIdx = document.getElementById('sectionForItem').value;
  let itemIdx = document.getElementById('itemList').value;
  if (itemIdx < 0) return;

  // Update the item data
  baseData[sectionIdx].items[itemIdx] = {
    item: document.getElementById('itemName').value,
    unit: document.getElementById('itemUnit').value,
    unitPrice: parseFloat(document.getElementById('itemPrice').value) || 0,
    baseQty: parseFloat(document.getElementById('itemQty').value) || 0
  };

  // Repopulate the item list dropdown
  populateItemList();

  // Restore the selection to the updated item
  document.getElementById('itemList').value = itemIdx;

  // Reload item details inputs to reflect updated data
  loadItemDetails();

  // Recalculate costs
  calculateCost();
}


function deleteItem() {
  const secIdx = Number(document.getElementById('sectionForItem').value || 0);
  const itIdx = Number(document.getElementById('itemList').value || 0);
  if (!baseData[secIdx] || !baseData[secIdx].items[itIdx]) return;
  if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ØŸ')) return;
  baseData[secIdx].items.splice(itIdx, 1);
  populateItemList();
  // reset selection
  const itemList = document.getElementById('itemList');
  if (itemList.options.length) itemList.selectedIndex = 0;
  lastItemIdx = itemList.value || null;
  loadItemDetails();
  calculateCost();
}

/* ---------- Calculation ---------- */


function calculateCost() {
  let html = '';

  // 1ï¸âƒ£ Get the input values
  let buildLength = parseFloat(document.getElementById('buildLength').value) || 0;
  let buildWidth = parseFloat(document.getElementById('buildWidth').value) || 0;
  let numFloors = parseFloat(document.getElementById('numFloors').value) || 1;
  let hasBasement = document.getElementById('hasBasement').checked;

  // 2ï¸âƒ£ Calculate total building area (floors + basement if any)
  let buildArea = buildLength * buildWidth;
  let totalArea = buildLength * buildWidth
//  let totalArea = buildArea * numFloors;
// if (hasBasement) totalArea += buildArea;

  // 3ï¸âƒ£ Track the grand total
  let grandTotal = 0;

  // 4ï¸âƒ£ Loop through each section
  baseData.forEach(section => {
    let sectionTotal = 0;
    html += `<h3>${section.name}</h3><table><thead><tr>
      <th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
    </tr></thead><tbody>`;

    section.items.forEach(item => {
      // Convert unit string to number (e.g., "100" means base area of 100m2)
      let baseUnitArea = parseFloat(item.unit) || 1;

      // Scale baseQty by ratio of actual totalArea to baseUnitArea
      let adjustedQty = (totalArea / baseUnitArea) * item.baseQty;

      // Calculate item total cost
      let itemTotal = adjustedQty * item.unitPrice;
      sectionTotal += itemTotal;

      html += `<tr>
        <td>${item.item}</td>
        <td>${item.unit}</td>
        <td>${adjustedQty.toFixed(2)}</td>
        <td>${item.unitPrice.toFixed(2)}</td>
        <td>${itemTotal.toFixed(2)}</td>
      </tr>`;
    });

    grandTotal += sectionTotal;

    html += `<tr><td colspan="4"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</strong></td><td><strong>${sectionTotal.toFixed(2)}</strong></td></tr></tbody></table>`;
  });

  // 5ï¸âƒ£ Display grand total
  let grandTotalHtml = `<h2 style="color: red;">ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: ${grandTotal.toFixed(2)}</h2>`;
  document.getElementById('costOutput').innerHTML = grandTotalHtml + html;
  document.getElementById('costOutput').style.display = 'block'; // make sure it's visible
}



/* ---------- Export / Import ---------- */
function customStringify(data) {
  // Build JSON manually so each item object is one line
  const lines = ['['];
  data.forEach((sec, si) => {
    lines.push('  {');
    lines.push(`    "name": ${JSON.stringify(sec.name)},`);
    lines.push('    "items": [');
    (sec.items || []).forEach((it, ii) => {
      // Build single-line item JSON (consistent ordering)
      const itemObj = {
        item: it.item,
        unit: it.unit,
        unitPrice: it.unitPrice,
        baseQty: it.baseQty,
        // only include ignoreFloors if true to keep JSON compact
        ...(it.ignoreFloors ? { ignoreFloors: true } : {})
      };
      let itemStr = JSON.stringify(itemObj);
      if (ii < (sec.items || []).length - 1) itemStr += ',';
      lines.push('      ' + itemStr);
    });
    lines.push('    ]');
    lines.push(si < data.length - 1 ? '  },' : '  }');
  });
  lines.push(']');
  return lines.join('\n');
}

function exportModel() {
  const blob = new Blob([customStringify(baseData)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'binaa_maghreb_model.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importModel(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const parsed = JSON.parse(ev.target.result);
      if (!Array.isArray(parsed)) throw new Error('Invalid model file');
      baseData = parsed;
      refreshSectionSelects();
      populateItemList();
      loadItemDetails();
      calculateCost();
    } catch (err) {
      alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­: ' + err.message);
    }
  };
  reader.readAsText(file);
}

/* ---------- PDF / Excel export ---------- */
function exportToPDF() {
  const element = document.getElementById('costOutput');
  const inputsSummary = `
    <div>
      <h2>Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª</h2>
      <p>Ø·ÙˆÙ„ Ø§Ù„Ù…Ø¨Ù†Ù‰: ${document.getElementById('buildLength').value || 0} Ù…</p>
      <p>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ù†Ù‰: ${document.getElementById('buildWidth').value || 0} Ù…</p>
      <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚: ${document.getElementById('numFloors').value || 0}</p>
      <p>ÙˆØ¬ÙˆØ¯ Ù‚Ø¨Ùˆ: ${document.getElementById('hasBasement').checked ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}</p>
    </div>
  `;
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = inputsSummary + element.outerHTML;
  html2pdf().from(tempDiv).save('cost_estimation.pdf');
}



/* ---------- Utilities ---------- */
function logRow(msg) { if (LOG_ENABLED) console.log(msg); }
function escapeHtml(s) { if (!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

/* ---------- Event wiring ---------- */
document.getElementById('sectionForItem').addEventListener('change', () => {
  // save current and repopulate items
  populateItemList();
  // select first item and load details
  const itSel = document.getElementById('itemList');
  if (itSel.options.length) itSel.selectedIndex = 0;
  loadItemDetails();
});
document.getElementById('itemList').addEventListener('change', loadItemDetails);

// auto recalc when inputs change
['buildLength','buildWidth','numFloors','hasBasement'].forEach(id => {
  document.getElementById(id).addEventListener('change', calculateCost);
});

/* ---------- Init on load ---------- */
window.addEventListener('DOMContentLoaded', () => {
  loadDefaultData();
});



function isMobile() {
  return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
}

function exportCostEstimation() {
  if (isMobile()) {
    exportTablesToCSV('cost_estimation.csv');
  } else {
    exportAllToExcel('cost_estimation.xlsx');
  }
}

// === PC: Export to Excel ===
function exportToExcel() {
  const costTable = document.getElementById('costOutput');
  const wb = XLSX.utils.book_new();

  const costRows = costTable.getElementsByTagName('tr');
  const costData = [['Ø§Ù„Ù…Ø±Ø­Ù„Ø©', 'Ø§Ù„Ù…Ø§Ø¯Ø©', 'Ø§Ù„ÙƒÙ…ÙŠØ© (baseQty)', 'Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©', 'Ø§Ù„ØªÙƒÙ„ÙØ©', 'Ù…Ù„Ø§Ø­Ø¸Ø©']];

  for (let row of costRows) {
    const cells = row.getElementsByTagName('td');
	
	  if (cells.length < 6) {
    console.warn('Row does not have enough cells:', row);
    continue; // skip this row if not enough cells
  }
    costData.push([
      cells[1].textContent.trim(), // Ø§Ù„Ù…Ø±Ø­Ù„Ø©
      cells[0].textContent.trim(), // Ø§Ù„Ù…Ø§Ø¯Ø©
      cells[2].querySelector('input')?.value || '', // Ø§Ù„ÙƒÙ…ÙŠØ©
      cells[4].querySelector('input')?.value || '', // Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©
      cells[5].textContent.trim(), // Ø§Ù„ØªÙƒÙ„ÙØ© (Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ)
      '' // Ù…Ù„Ø§Ø­Ø¸Ø©
    ]);
  }





  const costWs = XLSX.utils.aoa_to_sheet(costData);
  XLSX.utils.book_append_sheet(wb, costWs, 'Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©');

  const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  const blob = new Blob([wbout], { type: 'application/octet-stream' });

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'cost_estimation.xlsx';
  document.body.appendChild(a);
  a.click();

  setTimeout(() => {
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  }, 0);
}

// === Mobile: Export to CSV ===
function exportTablesToCSV() {
  const costOutput = document.getElementById('costOutput');
  if (!costOutput) {
    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙˆÙ„ Ù„ØªØµØ¯ÙŠØ±Ù‡!');
    return;
  }

  // Find all tables inside costOutput (each section has a table)
  const tables = costOutput.querySelectorAll('table');
  if (tables.length === 0) {
    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ø¯Ø§ÙˆÙ„ ÙÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.');
    return;
  }

  tables.forEach((table, index) => {
    let csv = [];
    
    // Get section name - the <h3> before the table
    let sectionName = 'Section_' + (index + 1);
    const prevHeading = table.previousElementSibling;
    if (prevHeading && prevHeading.tagName === 'H3') {
      sectionName = prevHeading.textContent.trim().replace(/\s+/g, '_');
    }

    // Extract rows
    const rows = table.querySelectorAll('tr');
    rows.forEach(row => {
      const cols = row.querySelectorAll('th, td');
      const rowData = [];
      cols.forEach(col => {
        // Escape double quotes in cell text
        let text = col.textContent.replace(/"/g, '""');
        // Wrap text in quotes if it contains comma or newlines
        if (text.search(/("|,|\n)/g) >= 0) text = `"${text}"`;
        rowData.push(text);
      });
      csv.push(rowData.join(','));
    });

    // Create CSV string
    const csvString = csv.join('\n');

    // Download CSV file
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${sectionName}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
}



function exportAllToExcel(filename) {
  const wb = XLSX.utils.book_new();

  // 1ï¸âƒ£ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ (from costTable) with Ø¥Ø¬Ù…Ø§Ù„ÙŠ
  const costTable = document.getElementById('costTable');
  if (costTable) {
    const ws1 = XLSX.utils.table_to_sheet(costTable);

    // Find last row and add Ø¥Ø¬Ù…Ø§Ù„ÙŠ
    const range1 = XLSX.utils.decode_range(ws1['!ref']);
    const totalRow1 = range1.e.r + 1;
    XLSX.utils.sheet_add_aoa(ws1, [['', '', '', '', '', 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', '=SUM(F2:F' + (range1.e.r + 1) + ')']], { origin: 'A' + (totalRow1 + 1) });

    XLSX.utils.book_append_sheet(wb, ws1, 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ');
  }

  // 2ï¸âƒ£ Ù…Ù„Ø®Øµ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ (from summaryTable) with Ø¥Ø¬Ù…Ø§Ù„ÙŠ
  const summaryTable = document.getElementById('summaryTable');
  if (summaryTable) {
    const ws2 = XLSX.utils.table_to_sheet(summaryTable);

    const range2 = XLSX.utils.decode_range(ws2['!ref']);
    const totalRow2 = range2.e.r + 1;
    XLSX.utils.sheet_add_aoa(ws2, [['', '', 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', '=SUM(C2:C' + (range2.e.r + 1) + ')']], { origin: 'A' + (totalRow2 + 1) });

    XLSX.utils.book_append_sheet(wb, ws2, 'Ù…Ù„Ø®Øµ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ');
  }

  // 3ï¸âƒ£ Detailed Raw Data (from baseData) with Ø¥Ø¬Ù…Ø§Ù„ÙŠ
  if (typeof baseData !== 'undefined') {
    const detailed = [['Ø§Ù„Ù…Ø§Ø¯Ø©', 'Ø§Ù„Ù…Ø±Ø­Ù„Ø©', 'Ø§Ù„ÙƒÙ…ÙŠØ© (baseQty)', 'Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©', 'Ø§Ù„ØªÙƒÙ„ÙØ©', 'Ù…Ù„Ø§Ø­Ø¸Ø©']];
    let grandTotal = 0;

    baseData.forEach(sec => {
      (sec.items || []).forEach(it => {
        const cost = it.baseQty * it.unitPrice;
        grandTotal += cost;
        detailed.push([it.item, sec.name, it.baseQty, it.unitPrice, cost, it.ignoreFloors ? 'ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚' : '']);
      });
    });

    detailed.push(['', '', '', '', 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', grandTotal]);

    const ws3 = XLSX.utils.aoa_to_sheet(detailed);
    XLSX.utils.book_append_sheet(wb, ws3, 'Detailed Raw Data');
  }

  // Export the workbook
  XLSX.writeFile(wb, filename || 'cost_estimation.xlsx');
}




</script>
</body>
</html>

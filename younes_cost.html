<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø­Ø§Ø³Ø¨Ø© ØªÙƒÙ„ÙØ© Ø¨Ù†Ø§Ø¡ Ù…Ù†Ø²Ù„ Ù…Ø¹ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap" rel="stylesheet">
  <style>
    .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .tooltip-container {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .tooltip-text {
      visibility: hidden;
      max-width: 300px;
      background-color: #004080;
      color: #fff;
      text-align: center;
      padding: 6px 10px;
      border-radius: 6px;
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      white-space: normal;
      font-size: 14px;
      line-height: 1.3;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .tooltip-container:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    .tooltip-text::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -6px;
      border-width: 6px;
      border-style: solid;
      border-color: #004080 transparent transparent transparent;
    }
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: 'Amiri', 'Noto Sans Arabic', Tahoma, sans-serif;
      background: #f4e7d3 url('https://www.transparenttextures.com/patterns/arabesque.png') repeat;
      direction: rtl;
      overflow-x: hidden;
      color: #3c2f2f;
    }
    .container {
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
      background: #fffcf7;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      box-sizing: border-box;
      min-height: 100%;
      border: 3px solid #d4a373;
    }
    h2, h3 {
      color: #004aad;
      margin: 15px 0;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      position: relative;
    }
    h2::after, h3::after {
      content: '';
      display: block;
      width: 100px;
      height: 4px;
      background: linear-gradient(to left, #d4a373, #004aad);
      margin: 10px auto;
      border-radius: 2px;
    }
    label {
      font-weight: bold;
      color: #3c2f2f;
      display: block;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      box-sizing: border-box;
      font-size: 16px;
      min-height: 48px;
      border: 2px solid #d4a373;
      border-radius: 8px;
      background: #fff;
      color: #3c2f2f;
    }
    button {
      background: linear-gradient(45deg, #004aad, #007bff);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: transform 0.2s, background 0.3s;
    }
    button:hover {
      background: linear-gradient(45deg, #003087, #005bb5);
      transform: scale(1.02);
    }
    .table-responsive {
      overflow-x: auto;
      margin-top: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: #fffcf7;
      border: 2px solid #d4a373;
    }
    th, td {
      border: 1px solid #d4a373;
      padding: 10px;
      text-align: center;
      color: #3c2f2f;
    }
    th {
      background: linear-gradient(to bottom, #004aad, #007bff);
      color: white;
      font-weight: bold;
    }
    .section-title {
      background: #e8f5e9;
      font-weight: bold;
      font-size: 18px;
      color: #2e7d32;
      padding: 10px;
      border-radius: 8px;
      margin-top: 20px;
      border: 2px solid #d4a373;
      position: relative;
      overflow: hidden;
    }
    .section-title::before {
      content: 'â—‡â—†â—‡';
      position: absolute;
      top: 50%;
      left: 10px;
      transform: translateY(-50%);
      color: #d4a373;
      opacity: 0.3;
    }
    .floor-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      direction: rtl;
      font-size: 16px;
      margin-bottom: 10px;
      gap: 10px;
      flex-wrap: wrap;
      background: #fff3cd;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #d4a373;
    }
    .left {
      text-align: left;
      direction: ltr;
      flex: 1;
      color: #28a745;
      font-weight: bold;
    }
    .center {
      flex: 2;
      text-align: center;
      font-weight: normal;
    }
    .right {
      text-align: right;
      flex: 1;
    }
    .price-color {
      color: #007bff;
      font-size: 22px;
      font-weight: bold;
    }
    .meter-color {
      font-weight: bold;
      font-size: 22px;
    }
    .final-total {
      background: #ffebee;
      font-weight: bold;
      font-size: 20px;
      color: #c62828;
      padding: 15px;
      margin-top: 25px;
      border-radius: 12px;
      text-align: center;
      border: 2px solid #d4a373;
    }
    .house-type {
      background: #ede7f6;
      color: #512da8;
      font-weight: bold;
      padding: 12px;
      margin: 15px 0;
      border-radius: 10px;
      text-align: center;
      border: 2px solid #d4a373;
    }
    input.unit-price-input, input.base-qty-input {
      width: 80px;
      padding: 6px;
      font-size: 14px;
      border: 1px solid #d4a373;
      border-radius: 6px;
      text-align: center;
    }
    table[border="1"] {
      width: 100%;
      max-width: 90%;
      margin: 20px auto;
      border-collapse: collapse;
      font-family: 'Amiri', 'Noto Sans Arabic', Arial, sans-serif;
      background: #fffcf7;
      border: 2px solid #d4a373;
    }
    button[onclick="exportTablesToExcel()"] {
      background-color: #B4462F;
      color: #F5E8D3;
      font-size: 18px;
      font-family: 'Cinzel', serif;
      padding: 14px 24px;
      border: 2px solid #D4A017;
      border-radius: 12px;
      cursor: pointer;
      display: block;
      margin: 20px auto;
      text-align: center;
      direction: rtl;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }
    button[onclick="exportTablesToExcel()"]:hover {
      background-color: #2E8B57;
      transform: scale(1.05);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
    }
    #errorMessage {
      color: red;
      font-size: 16px;
      text-align: center;
      margin: 10px 0;
    }
    @media only screen and (max-width: 600px) {
      body {
        padding: 5px;
      }
      .container {
        padding: 10px;
      }
      h2, h3 {
        font-size: 16px;
      }
      table {
        font-size: 13px;
      }
      th, td {
        padding: 6px;
      }
      input.unit-price-input, input.base-qty-input {
        width: 60px;
        font-size: 12px;
      }
      button {
        font-size: 14px;
        padding: 10px;
      }
      table[border="1"] {
        max-width: 100%;
      }
      .section-title, .floor-total, .final-total, .house-type {
        font-size: 14px;
        padding: 8px;
      }
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <div class="container mx-auto p-6 max-w-4xl">
    <h1 class="text-3xl font-bold text-center mb-4 text-blue-800">Ø­Ø§Ø³Ø¨Ø© ØªÙƒÙ„ÙØ© Ø¨Ù†Ø§Ø¡ Ù…Ù†Ø²Ù„ Ù…Ø¹ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h1>

    <!-- Input Form -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
      <div style="background-color:#f0f8ff; border: 2px solid #4a90e2; padding: 15px; border-radius: 8px; font-family: 'Arial', sans-serif; color: #333; max-width: 800px; line-height: 1.5; margin: 50px auto; text-align: center;">
        <p style="font-size: 18px; margin: 0; display: inline-block; text-align: right;">
          <span style="color: #e67e22; font-weight: bold;">ğŸ“Œ</span> ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ <strong>Ø§Ù„Ù…Ø³Ø§Ø­Ø©</strong> ÙˆØ¹Ø¯Ø¯ <strong>Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚</strong> Ø­Ø³Ø¨ Ù…Ø´Ø±ÙˆØ¹ÙƒØŒ Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ 
          <span style="background-color: #4a90e2; color: white; padding: 3px 8px; border-radius: 4px; font-weight: bold;">Ø§Ø­Ø³Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ©</span> 
          Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙ‚Ø¯ÙŠØ± ØªÙ‚Ø±ÙŠØ¨ÙŠ ÙŠÙˆØ¶Ø­ ÙÙƒØ±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù† Ø§Ù„ØªÙƒÙ„ÙØ©. ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ø§Ù‹ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨ØµÙŠØºØªÙŠ <strong>PDF</strong> Ø£Ùˆ <strong>Excel</strong> Ù„Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡Ø§.
        </p>
      </div>
      <div id="errorMessage" class="text-red-600 mb-4 hidden"></div>

      <!-- Dimensions Section -->
      <h3 class="text-lg font-semibold mb-3 text-blue-600">Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium" for="buildLength">Ø·ÙˆÙ„ Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ù…ØªØ±):</label>
          <input id="buildLength" type="number" min="0" step="0.1" class="mt-1 p-2 w-full border rounded" value="10" placeholder="Ù…Ø«Ø§Ù„: 10" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø·ÙˆÙ„ Ø§Ù„Ù…Ø¨Ù†Ù‰ Ø¨Ø§Ù„Ù…ØªØ±">
        </div>
        <div>
          <label class="block text-sm font-medium" for="buildWidth">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ù…ØªØ±):</label>
          <input id="buildWidth" type="number" min="0" step="0.1" class="mt-1 p-2 w-full border rounded" value="12" placeholder="Ù…Ø«Ø§Ù„: 12" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ù†Ù‰ Ø¨Ø§Ù„Ù…ØªØ±">
        </div>
        <div>
          <label class="block text-sm font-medium" for="landLength">Ø·ÙˆÙ„ Ø§Ù„Ø£Ø±Ø¶ (Ù…ØªØ±):</label>
          <input id="landLength" type="number" min="0" step="0.1" class="mt-1 p-2 w-full border rounded" value="10" placeholder="Ù…Ø«Ø§Ù„: 10" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø·ÙˆÙ„ Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„Ù…ØªØ±">
        </div>
        <div>
          <label class="block text-sm font-medium" for="landWidth">Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø¶ (Ù…ØªØ±):</label>
          <input id="landWidth" type="number" min="0" step="0.1" class="mt-1 p-2 w-full border rounded" value="12" placeholder="Ù…Ø«Ø§Ù„: 12" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„Ù…ØªØ±">
        </div>
        <div>
          <label class="block text-sm font-medium" for="numFloors">Ø¹Ø¯Ø¯ Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚ (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø³Ø·Ø­):</label>
          <input id="numFloors" type="number" min="1" step="1" class="mt-1 p-2 w-full border rounded" value="2" placeholder="Ù…Ø«Ø§Ù„: 1" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø¹Ø¯Ø¯ Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚">
        </div>
        <div>
          <label class="block text-lg font-medium" for="hasBasement" style="color: blue;">
            Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ù‚Ø¨ÙˆØŸ (La cave)
          </label>
          <small style="color: gray;">Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ Ù‚Ø¨ÙˆØŒ Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ù‡Ù†Ø§</small><br>
          <input id="hasBasement" type="checkbox" style="width: 16px; height: 16px;" onclick="debouncedCalculateCost()" aria-label="Ø¥Ø¶Ø§ÙØ© Ù‚Ø¨Ùˆ">
        </div>
        <div>
          <label class="block text-sm font-medium" for="semelleCount">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù…Ù„Ø§Øª (Semelle) â€” Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©</label>
          <input id="semelleCount" type="number" min="1" step="1" class="mt-1 p-2 w-full border rounded" value="16" placeholder="Ù…Ø«Ø§Ù„: 16" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù…Ù„Ø§Øª">
        </div>
      </div>

      <!-- Material Prices Section -->
      <h3 class="text-lg font-semibold mt-6 mb-3 text-blue-600">
        Ø£Ø³Ø¹Ø§Ø± Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£Ø´ØºØ§Ù„ Ø§Ù„ÙƒØ¨Ø±Ù‰ (gros Å“uvre)ØŒ ÙˆÙÙ‚ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©. ÙŠÙ…ÙƒÙ†ÙƒÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø¹Ù†Ø¯ ØªØºÙŠÙ‘Ø± Ø§Ù„Ø£Ø³Ø¹Ø§Ø±.
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium" for="betonPrice">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØªÙˆÙ† (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ/Ù…Â³):</label>
          <input id="betonPrice" type="number" min="0" step="0.1" class="mt-1 p-2 w-full border rounded" value="850" placeholder="Ù…Ø«Ø§Ù„: 850" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØªÙˆÙ† Ù„ÙƒÙ„ Ù…ØªØ± Ù…ÙƒØ¹Ø¨">
        </div>
        <div>
          <label class="block text-sm font-medium" for="b15Price">Ø³Ø¹Ø± Ø®Ø±Ø³Ø§Ù†Ø© Ø§Ù„Ù†Ø¸Ø§ÙØ© B15 (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ/Ù…Â³):</label>
          <input id="b15Price" type="number" min="0" step="0.1" class="mt-1 p-2 w-full border rounded" value="850" placeholder="Ù…Ø«Ø§Ù„: 850" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø³Ø¹Ø± Ø®Ø±Ø³Ø§Ù†Ø© Ø§Ù„Ù†Ø¸Ø§ÙØ© B15">
        </div>
        <div>
          <label class="block text-sm font-medium" for="ironPrice">Ø³Ø¹Ø± Ø§Ù„Ø­Ø¯ÙŠØ¯ (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ/ÙƒØ¬Ù…):</label>
          <input id="ironPrice" type="number" min="0" step="0.1" class="mt-1 p-2 w-full border rounded" value="9.5" placeholder="Ù…Ø«Ø§Ù„: 9.5" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø³Ø¹Ø± Ø§Ù„Ø­Ø¯ÙŠØ¯ Ù„ÙƒÙ„ ÙƒÙŠÙ„ÙˆØºØ±Ø§Ù…">
        </div>
        <div>
          <label class="block text-sm font-medium" for="cementPrice">Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ù…Ù†Øª (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ/Ø®Ù†Ø´Ø©):</label>
          <input id="cementPrice" type="number" min="0" step="0.1" class="mt-1 p-2 w-full border rounded" value="82" placeholder="Ù…Ø«Ø§Ù„: 82" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ù…Ù†Øª Ù„ÙƒÙ„ Ø®Ù†Ø´Ø©">
        </div>
        <div>
          <label class="block text-sm font-medium" for="excavationPrice">Ø³Ø¹Ø± Ø§Ù„Ø­ÙØ± (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ/Ù…Â³):</label>
          <input id="excavationPrice" type="number" min="0" step="0.1" class="mt-1 p-2 w-full border rounded" value="35" placeholder="Ù…Ø«Ø§Ù„: 35" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø³Ø¹Ø± Ø§Ù„Ø­ÙØ± Ù„ÙƒÙ„ Ù…ØªØ± Ù…ÙƒØ¹Ø¨">
        </div>
        <div class="tooltip-container">
          <label for="gravelPrice" class="block text-sm font-medium">Ø³Ø¹Ø± Ø­ØµÙ‰ Ø§Ù„ÙÙŠØ§Ø¬ (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ/Ù…Â³):</label>
          <input id="gravelPrice" type="number" min="0" step="0.1" value="148" placeholder="Ù…Ø«Ø§Ù„: 148" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø³Ø¹Ø± Ø­ØµÙ‰ Ø§Ù„ÙÙŠØ§Ø¬" class="mt-1 p-2 w-full border rounded">
          <div class="tooltip-text">Ø§Ù„ØªØºØ·ÙŠØ© (ÙÙŠØ§Ø¬) Ø§Ù„ØªÙŠ ØªØ³Ø§ÙˆÙŠ 25 Ù…Â³ ØªÙƒÙ„Ù 3700 Ø¯Ø±Ù‡Ù…ØŒ Ø£ÙŠ 148 Ø¯Ø±Ù‡Ù… Ù„Ù„Ù…ØªØ± Ø§Ù„Ù…ÙƒØ¹Ø¨.</div>
        </div>
        <div>
          <label class="block text-sm font-medium" for="brickPrice">Ø³Ø¹Ø± Ø§Ù„Ø·ÙˆØ¨ (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ/Ø­Ø¨Ø©):</label>
          <input id="brickPrice" type="number" min="0" step="0.1" class="mt-1 p-2 w-full border rounded" value="6.5" placeholder="Ù…Ø«Ø§Ù„: 6.5" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø³Ø¹Ø± Ø§Ù„Ø·ÙˆØ¨ Ù„ÙƒÙ„ Ø­Ø¨Ø©">
        </div>
        <div class="tooltip-container">
          <label for="sandPrice" class="block text-sm font-medium">Ø³Ø¹Ø± Ø±Ù…Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡ (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ/Ù…Â³):</label>
          <input id="sandPrice" type="number" min="0" step="0.1" value="240" placeholder="Ù…Ø«Ø§Ù„: 240" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø³Ø¹Ø± Ø±Ù…Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡" class="mt-1 p-2 w-full border rounded">
          <div class="tooltip-text">ÙƒÙ…ÙŠØ© 25 Ù…Â² ØªÙƒÙ„Ù 6000 Ø¯Ø±Ù‡Ù…ØŒ ÙˆØ§Ù„ØªØºØ·ÙŠØ© (ÙÙŠØ§Ø¬) Ù‡ÙŠ 240 Ø¯Ø±Ù‡Ù… Ù„Ù„Ù…ØªØ± Ø§Ù„Ù…ÙƒØ¹Ø¨.</div>
        </div>
        <div>
          <label class="block text-sm font-medium" for="aggregatePrice">Ø³Ø¹Ø± Ø§Ù„Ø­ØµÙ‰ (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ/Ù…Â³):</label>
          <input id="aggregatePrice" type="number" min="0" step="0.1" class="mt-1 p-2 w-full border rounded" value="160" placeholder="Ù…Ø«Ø§Ù„: 160" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø³Ø¹Ø± Ø§Ù„Ø­ØµÙ‰">
        </div>
        <div>
          <label class="block text-sm font-medium" for="laborPrice">Ø³Ø¹Ø± Ø§Ù„ÙŠØ¯ Ø§Ù„Ø¹Ø§Ù…Ù„Ø© (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ/Ù…Â²):</label>
          <input id="laborPrice" type="number" min="0" step="0.1" class="mt-1 p-2 w-full border rounded" value="240" placeholder="Ù…Ø«Ø§Ù„: 240" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø³Ø¹Ø± Ø§Ù„ÙŠØ¯ Ø§Ù„Ø¹Ø§Ù…Ù„Ø© Ù„ÙƒÙ„ Ù…ØªØ± Ù…Ø±Ø¨Ø¹">
        </div>
        <div>
          <label class="block text-sm font-medium" for="sandFayagePrice">Ø³Ø¹Ø± Ø§Ù„Ø±Ù…Ù„ (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ/ÙÙŠØ§Ø¬):</label>
          <input id="sandFayagePrice" type="number" min="0" step="0.1" class="mt-1 p-2 w-full border rounded" value="6000" placeholder="Ù…Ø«Ø§Ù„: 6000" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø³Ø¹Ø± Ø§Ù„Ø±Ù…Ù„ Ù„ÙƒÙ„ ÙÙŠØ§Ø¬">
        </div>
        <div>
          <label class="block text-sm font-medium" for="combinedMaterialPrice">Ø³Ø¹Ø± Ø§Ù„ÙˆØ±Ø¯ÙŠ ÙˆØ§Ù„Ø¨ÙˆØ¯Ø± ÙˆØ§Ù„Ø´Ø¨ÙƒØ© (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ/Ù…Â²):</label>
          <input id="combinedMaterialPrice" type="number" min="0" step="0.1" class="mt-1 p-2 w-full border rounded" value="85" placeholder="Ù…Ø«Ø§Ù„: 85" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø³Ø¹Ø± Ø§Ù„ÙˆØ±Ø¯ÙŠ ÙˆØ§Ù„Ø¨ÙˆØ¯Ø± ÙˆØ§Ù„Ø´Ø¨ÙƒØ© Ù„ÙƒÙ„ Ù…ØªØ± Ù…Ø±Ø¨Ø¹">
        </div>
        <div>
          <label class="block text-sm font-medium" for="stonePrice">Ø³Ø¹Ø± Ø§Ù„Ø­Ø¬Ø± Ù„Ù„Ø¨Ù„ÙˆÙƒØ§Ø¬ (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ/ÙÙŠØ§Ø¬):</label>
          <input id="stonePrice" type="number" min="0" step="0.1" class="mt-1 p-2 w-full border rounded" value="3500" placeholder="Ù…Ø«Ø§Ù„: 3500" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø³Ø¹Ø± Ø§Ù„Ø­Ø¬Ø± Ù„Ù„Ø¨Ù„ÙˆÙƒØ§Ø¬ Ù„ÙƒÙ„ ÙÙŠØ§Ø¬">
        </div>
        <div>
          <label class="block text-sm font-medium" for="sacksPrice">Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠØ§Ø³ (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ/ÙÙŠØ§Ø¬):</label>
          <input id="sacksPrice" type="number" min="0" step="0.1" class="mt-1 p-2 w-full border rounded" value="3500" placeholder="Ù…Ø«Ø§Ù„: 3500" oninput="restrictPositiveNumber(this)" onchange="debouncedCalculateCost()" aria-label="Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠØ§Ø³ Ù„ÙƒÙ„ ÙÙŠØ§Ø¬">
        </div>
      </div>

      <div class="flex justify-center gap-4 mt-6">
        <button onclick="calculateCost()" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Ø§Ø­Ø³Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¢Ù†</button>
        <button onclick="resetForm()" class="w-full bg-gray-600 text-white p-2 rounded hover:bg-gray-700">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
      </div>
    </div>

    <!-- Cost Output -->
    <div id="costOutput" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
      <h3 style="color: #004aad; font-size: 20px; text-align: center;">
        ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ù†Ø²Ù„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ø£Ø³Ø¹Ø§Ø± Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ÙˆØ§Ø±Ø¯Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£Ø¹Ù„Ø§Ù‡.
      </h3>
      <h3 style="color: #004aad; font-size: 20px; text-align: center;">
        ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ "Ø§Ù„ÙƒÙ…ÙŠØ©" Ø­Ø³Ø¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ØŒ Ù…Ø¹ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ù„ÙƒÙ„ Ù…Ø§Ø¯Ø©.
        ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ ØªÙƒÙ„ÙØ© Ø§Ù„Ø­ÙØ± (Ù…Ø«Ù„Ø§Ù‹ Ù…Ù† 35 Ø¥Ù„Ù‰ 50) ÙˆØ³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
      </h3>
      <h3 style="color: #004aad; font-size: 20px; text-align: center;">
        ÙˆÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠÙ…ÙƒÙ†Ùƒ Ø±Ø¤ÙŠØ© Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ù…Ù„Ø®Øµ Ù„ÙƒÙ„ Ù…Ø§Ø¯Ø© Ù„ÙƒÙ„ Ø§Ù„Ù…Ù†Ø²Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ø§Ù‹ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ØµÙŠØºØ© PDF Ø£Ùˆ Excel
      </h3>
      <h2 class="text-xl font-semibold mb-4 text-blue-700">
        ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙƒÙ„ÙØ©
        Ø§Ù„ØªÙƒÙ„ÙØ© Ø³ØªØ¸Ù‡Ø± Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¥Ø°Ø§ Ù‚Ù…Øª Ø¨ØªØ¯ÙˆÙŠØ± Ø§Ù„Ù‡Ø§ØªÙ Ø£ÙÙ‚ÙŠÙ‹Ø§ØŒ Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ø§Ù‹ Ø±Ø¤ÙŠØªÙ‡Ø§ Ù…Ù† Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±.
      </h2>
      <table class="w-full border-collapse mb-6">
        <thead>
          <tr class="bg-blue-600 text-white">
            <th class="border p-2">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
            <th class="border p-2">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
            <th class="border p-2">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th class="border p-2">Ø§Ù„ØªÙƒÙ„ÙØ© Ù„ÙƒÙ„ ÙˆØ­Ø¯Ø© (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ)</th>
            <th class="border p-2">Ø§Ù„ØªÙƒÙ„ÙØ© (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ)</th>
            <th class="border p-2">Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØºØ·Ø§Ø© (Ù…Â²)</th>
          </tr>
        </thead>
        <tbody id="costTableBody"></tbody>
      </table>
      <h3 class="text-lg font-semibold mt-4 text-blue-800">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="totalCost">0</span> Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ</h3>
      <h2 class="text-xl font-semibold mt-6 mb-4 text-blue-700">Ù…Ù„Ø®Øµ Ø§Ù„ØªÙƒÙ„ÙØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø©</h2>
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-blue-200">
            <th class="border p-2">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
            <th class="border p-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th class="border p-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ© (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ)</th>
            <th class="border p-2">Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© (%)</th>
          </tr>
        </thead>
        <tbody id="summaryTableBody"></tbody>
      </table>
    </div>

    <!-- Export Buttons -->
    <div class="flex justify-center gap-4 mb-6">
      <button onclick="exportToPDF()" class="bg-green-600 text-white p-2 rounded hover:bg-green-700">ğŸ“„ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF</button>
      <button onclick="exportToExcel()" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¥Ù„Ù‰ Excel</button>
    </div>
  </div>

  <script>
    let costData = [];

    // Utility function to restrict input to positive numbers
    function restrictPositiveNumber(input) {
      input.value = input.value.replace(/[^0-9.]/g, '');
      if (input.value === '' || parseFloat(input.value) < 0 || input.value === '.') {
        input.value = input.defaultValue || '0';
      }
      if (parseFloat(input.value) > 1000000) {
        input.value = '1000000';
        showError('Ø§Ù„Ù‚ÙŠÙ…Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ù‹Ø§ØŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù‡Ùˆ 1,000,000');
      }
    }

    // Utility function to get valid number with fallback
    function getValidNumber(value, defaultValue, isInt = false) {
      const parsed = isInt ? parseInt(value) : parseFloat(value.replace(',', '.'));
      if (isNaN(parsed) || parsed < (isInt ? 1 : 0)) return defaultValue;
      if (parsed > 1000000) {
        showError('Ø§Ù„Ù‚ÙŠÙ…Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ù‹Ø§ØŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù‡Ùˆ 1,000,000');
        return defaultValue;
      }
      return parsed;
    }

    // Enhanced input validation
    function validateInputs(inputs) {
      const errors = [];
      for (const [id, value] of Object.entries(inputs)) {
        if (isNaN(value) || value <= 0) {
          const label = document.querySelector(`label[for="${id}"]`)?.textContent || id;
          errors.push(`ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø© ÙˆÙ…ÙˆØ¬Ø¨Ø© Ù„Ù€ ${label}`);
        }
        if (value > 1000000) {
          const label = document.querySelector(`label[for="${id}"]`)?.textContent || id;
          errors.push(`Ø§Ù„Ù‚ÙŠÙ…Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ù‹Ø§ Ù„Ù€ ${label}ØŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù‡Ùˆ 1,000,000`);
        }
      }
      return errors;
    }

    // Show error with timeout
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => errorDiv.classList.add('hidden'), 5000);
    }

    // Clear error
    function clearError() {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = '';
      errorDiv.classList.add('hidden');
    }

    // Debounce function to limit rapid calculateCost calls
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    const debouncedCalculateCost = debounce(calculateCost, 300);

    // Reset form to default values
    function resetForm() {
      const inputs = document.querySelectorAll('input[type="number"], input[type="checkbox"]');
      inputs.forEach(input => {
        if (input.type === 'number') {
          input.value = input.id === 'numFloors' ? 2 : input.id === 'semelleCount' ? 16 : 
                        input.id === 'betonPrice' ? 850 : input.id === 'b15Price' ? 850 : 
                        input.id === 'ironPrice' ? 9.5 : input.id === 'cementPrice' ? 82 : 
                        input.id === 'excavationPrice' ? 35 : input.id === 'gravelPrice' ? 148 : 
                        input.id === 'brickPrice' ? 6.5 : input.id === 'sandPrice' ? 240 : 
                        input.id === 'aggregatePrice' ? 160 : input.id === 'laborPrice' ? 240 : 
                        input.id === 'combinedMaterialPrice' ? 85 : input.id === 'stonePrice' ? 3500 : 
                        input.id === 'sacksPrice' ? 3500 : input.id === 'sandFayagePrice' ? 6000 : 
                        input.id === 'landLength' ? 10 : input.id === 'landWidth' ? 12 : 
                        input.id === 'buildLength' ? 10 : input.id === 'buildWidth' ? 12 : '0';
        } else if (input.type === 'checkbox') {
          input.checked = false;
        }
      });
      costData = [];
      document.getElementById('costOutput').classList.add('hidden');
      clearError();
    }

    // Calculate iron quantity
    function getIronQuantity(area) {
      /**
       * Calculate iron quantity (kg) for a house based on area per floor and number of floors from DOM.
       * Uses hard-coded iron costs from the Calculations table, divided by 980 DH/kg.
       * If area is not in the table, picks the nearest area.
       * 
       * @param {number} area - Area per floor in square meters.
       * @returns {number} - Iron quantity in kilograms, rounded to 2 decimal places.
       * @throws {Error} - If area is invalid or DOM element is missing.
       */
      const ironCosts = {
        'R+1': {
          80: 47040, 90: 52920, 100: 58800, 110: 64680, 120: 73500,
          130: 76440, 140: 82320, 150: 88200, 160: 94080, 170: 99960
        },
        'R+2': {
          80: 57432, 90: 64611, 100: 71790, 110: 78969, 120: 86148,
          130: 93327, 140: 100506, 150: 107685, 160: 114864, 170: 122043
        },
        'R+3': {
          80: 80221, 90: 90248, 100: 100276, 110: 110304, 120: 120331,
          130: 130359, 140: 140386, 150: 150414, 160: 160442, 170: 170469
        }
      };

      // Map number of floors to house type
      const floorToHouseType = {
        2: 'R+1',
        3: 'R+2',
        4: 'R+3'
      };

      // Get numFloors from DOM
      const numFloorsElement = document.getElementById('numFloors');
      if (!numFloorsElement) {
        throw new Error('DOM element with ID "numFloors" not found.');
      }
      const numFloorsValue = numFloorsElement.value.trim();
      if (numFloorsValue === '') {
        throw new Error('Number of floors input is empty. Please enter a number.');
      }
      const numFloors = parseInt(numFloorsValue);
      
      // Validate area
      if (isNaN(area) || area <= 0) {
        throw new Error('Area must be a positive number.');
      }

      // Map numFloors to house type (handle 1 or >4)
      let houseType;
      if (numFloors <= 1) {
        houseType = 'R+1'; // Treat 1 floor as R+1 (2 floors total)
      } else if (numFloors >= 4) {
        houseType = 'R+3'; // Cap at R+3 for 4+ floors
      } else {
        houseType = floorToHouseType[numFloors]; // 2 â†’ R+1, 3 â†’ R+2, 4 â†’ R+3
      }

      // Available areas from the table
      const availableAreas = [80, 90, 100, 110, 120, 130, 140, 150, 160, 170];

      // Find nearest area if input area is not in the table
      let closestArea = area;
      if (!ironCosts['R+1'][area]) {
        closestArea = availableAreas.reduce((prev, curr) =>
          Math.abs(curr - area) < Math.abs(prev - area) ? curr : prev
        );
      }

      // Get total iron cost
      const totalCost = ironCosts[houseType][closestArea];

      // Calculate iron quantity (kg) using cost per kg (980 DH/kg)
      const ironQuantity = totalCost / 980;

      // Log floor area, numFloors, closestArea, and ironQuantity for debugging
     // console.log(`Input Floor Area: ${area} mÂ²`);
     // console.log(`Number of Floors: ${numFloors}`);
     // console.log(`Closest Table Area: ${closestArea} mÂ²`);
     // console.log(`Iron Quantity: ${ironQuantity.toFixed(2)} kg`);

      // Removed *100 as it incorrectly scales the quantity
      return Number(ironQuantity.toFixed(2));
    }

    // Update tables with cost data
    function updateTables() {
      try {
        const totalCost = costData.reduce((sum, item) => sum + (item.stage.includes('Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª') ? 0 : (isNaN(item.totalCost) ? 0 : item.totalCost)), 0);
        const costTableBody = document.getElementById('costTableBody');
        costTableBody.innerHTML = costData.map((item, idx) => `
          <tr class="${item.material.startsWith('Ø§Ù„Ø­Ø¯ÙŠØ¯ ') ? 'bg-gray-100' : item.material === 'Ø§Ù„ÙˆØ±Ø¯ÙŠ ÙˆØ§Ù„Ø¨ÙˆØ¯Ø± ÙˆØ§Ù„Ø´Ø¨ÙƒØ©' || item.material === 'Ø§Ù„Ø­Ø¬Ø± (Ù„Ù„Ø¨Ù„ÙˆÙƒØ§Ø¬)' || item.material === 'Ø§Ù„ÙƒÙŠØ§Ø³' || item.material === 'Ø§Ù„Ø±Ù…Ù„' ? 'bg-blue-100' : idx % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
            <td class="border p-2">${item.material}</td>
            <td class="border p-2">${item.stage}</td>
            <td class="border p-2"><input type="number" value="${parseFloat(item.quantity).toFixed(2)}" step="0.1" min="0" onchange="updateQuantity(${idx}, this.value)" class="w-full p-1 border rounded" aria-label="Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ù€ ${item.material}"></td>
            <td class="border p-2"><input type="number" value="${item.unitPrice.toFixed(2)}" step="0.1" min="0" onchange="updateUnitPrice(${idx}, this.value)" class="w-full p-1 border rounded" aria-label="Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù€ ${item.material}"></td>
            <td class="border p-2">${isNaN(item.totalCost) ? '0.00' : item.totalCost.toFixed(2)}</td>
            <td class="border p-2">${isNaN(item.costPerM2) ? '0.00' : item.costPerM2.toFixed(2)}</td>
          </tr>
        `).join('');
        const materials = [
          'Ø­ÙØ± Ø§Ù„Ø£Ø³Ø§Ø³Ø§Øª',
          'Ø§Ù„Ø­Ø¯ÙŠØ¯',
          'Ø§Ù„Ø¨ÙŠØªÙˆÙ†',
          'Ø®Ø±Ø³Ø§Ù†Ø© Ø§Ù„Ù†Ø¸Ø§ÙØ© B15',
          'Ø§Ù„Ø£Ø³Ù…Ù†Øª',
          'Ø­ØµÙ‰ Ø§Ù„ÙÙŠØ§Ø¬',
          'Ø§Ù„Ø·ÙˆØ¨',
          'Ø±Ù…Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡',
          'Ø§Ù„Ø­ØµÙ‰',
          'Ø§Ù„ÙŠØ¯ Ø§Ù„Ø¹Ø§Ù…Ù„Ø©',
          'Ø§Ù„ÙˆØ±Ø¯ÙŠ ÙˆØ§Ù„Ø¨ÙˆØ¯Ø± ÙˆØ§Ù„Ø´Ø¨ÙƒØ©',
          'Ø§Ù„Ø­Ø¬Ø± (Ù„Ù„Ø¨Ù„ÙˆÙƒØ§Ø¬)',
          'Ø§Ù„ÙƒÙŠØ§Ø³',
          'Ø§Ù„Ø±Ù…Ù„'
        ];
        const summaryData = materials.map(material => {
          const items = costData.filter(item => (item.material === material || item.material.startsWith(material + ' ')) && !item.stage.includes('Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª'));
          const totalQuantity = items.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
          const totalCostItem = items.reduce((sum, item) => sum + (isNaN(item.totalCost) ? 0 : item.totalCost), 0);
          return {
            material,
            quantity: totalQuantity.toFixed(2),
            unit: items.length > 0 ? items[0].unit : '',
            totalCost: totalCostItem,
            percentage: totalCost > 0 ? (totalCostItem / totalCost * 100).toFixed(2) : 0
          };
        }).filter(item => item.quantity > 0);
        const summaryTableBody = document.getElementById('summaryTableBody');
        summaryTableBody.innerHTML = summaryData.map(item => `
          <tr class="${item.material === 'Ø§Ù„ÙˆØ±Ø¯ÙŠ ÙˆØ§Ù„Ø¨ÙˆØ¯Ø± ÙˆØ§Ù„Ø´Ø¨ÙƒØ©' || item.material === 'Ø§Ù„Ø­Ø¬Ø± (Ù„Ù„Ø¨Ù„ÙˆÙƒØ§Ø¬)' || item.material === 'Ø§Ù„ÙƒÙŠØ§Ø³' || item.material === 'Ø§Ù„Ø±Ù…Ù„' ? 'bg-blue-100' : ''}">
            <td class="border p-2">${item.material}</td>
            <td class="border p-2">${item.quantity} ${item.unit}</td>
            <td class="border p-2">${isNaN(item.totalCost) ? '0.00' : item.totalCost.toFixed(2)}</td>
            <td class="border p-2">${item.percentage}%</td>
          </tr>
        `).join('');
        document.getElementById('totalCost').textContent = isNaN(totalCost) ? '0.00' : totalCost.toFixed(2);
      } catch (error) {
        console.error('Error in updateTables:', error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª.');
      }
    }

    // Calculate construction cost
    function calculateCost() {
	
      try {
        const inputs = {
          landLength: document.getElementById('landLength').value,
          landWidth: document.getElementById('landWidth').value,
          buildLength: document.getElementById('buildLength').value,
          buildWidth: document.getElementById('buildWidth').value,
          numFloors: document.getElementById('numFloors').value,
          semelleCount: document.getElementById('semelleCount').value,
          betonPrice: document.getElementById('betonPrice').value,
          b15Price: document.getElementById('b15Price').value,
          ironPrice: document.getElementById('ironPrice').value,
          cementPrice: document.getElementById('cementPrice').value,
          excavationPrice: document.getElementById('excavationPrice').value,
          gravelPrice: document.getElementById('gravelPrice').value,
          brickPrice: document.getElementById('brickPrice').value,
          sandPrice: document.getElementById('sandPrice').value,
          aggregatePrice: document.getElementById('aggregatePrice').value,
          laborPrice: document.getElementById('laborPrice').value,
          combinedMaterialPrice: document.getElementById('combinedMaterialPrice').value,
          stonePrice: document.getElementById('stonePrice').value,
          sacksPrice: document.getElementById('sacksPrice').value,
          sandFayagePrice: document.getElementById('sandFayagePrice').value
        };

        // Validate inputs
        const validatedInputs = {
          landLength: getValidNumber(inputs.landLength, 10),
          landWidth: getValidNumber(inputs.landWidth, 12),
          buildLength: getValidNumber(inputs.buildLength, 10),
          buildWidth: getValidNumber(inputs.buildWidth, 12),
          numFloors: getValidNumber(inputs.numFloors, 2, true),
          semelleCount: getValidNumber(inputs.semelleCount, 16, true),
          betonPrice: getValidNumber(inputs.betonPrice, 850),
          b15Price: getValidNumber(inputs.b15Price, 850),
          ironPrice: getValidNumber(inputs.ironPrice, 9.5),
          cementPrice: getValidNumber(inputs.cementPrice, 82),
          excavationPrice: getValidNumber(inputs.excavationPrice, 35),
          gravelPrice: getValidNumber(inputs.gravelPrice, 148),
          brickPrice: getValidNumber(inputs.brickPrice, 6.5),
          sandPrice: getValidNumber(inputs.sandPrice, 240),
          aggregatePrice: getValidNumber(inputs.aggregatePrice, 160),
          laborPrice: getValidNumber(inputs.laborPrice, 240),
          combinedMaterialPrice: getValidNumber(inputs.combinedMaterialPrice, 85),
          stonePrice: getValidNumber(inputs.stonePrice, 3500),
          sacksPrice: getValidNumber(inputs.sacksPrice, 3500),
          sandFayagePrice: getValidNumber(inputs.sandFayagePrice, 6000)
        };

        const errors = validateInputs(validatedInputs);
        if (errors.length > 0) {
          showError(errors.join('\n'));
          return;
        }
        clearError();

        const landLength = validatedInputs.landLength;
        const landWidth = validatedInputs.landWidth;
        const buildLength = validatedInputs.buildLength;
        const buildWidth = validatedInputs.buildWidth;
        const numFloors = validatedInputs.numFloors;
        const hasBasement = document.getElementById('hasBasement').checked;
        const semelleCount = validatedInputs.semelleCount;
        const semelleLength = 1.5;
        const semelleWidth = 1.5;
        const semelleHeight = 0.3;
        const betonPrice = validatedInputs.betonPrice;
        const b15Price = validatedInputs.b15Price;
        const ironPrice = validatedInputs.ironPrice;
        const cementPrice = validatedInputs.cementPrice;
        const excavationPrice = validatedInputs.excavationPrice;
        const gravelPrice = validatedInputs.gravelPrice;
        const brickPrice = validatedInputs.brickPrice;
        const sandPrice = validatedInputs.sandPrice;
        const aggregatePrice = validatedInputs.aggregatePrice;
        const laborPrice = validatedInputs.laborPrice;
        const combinedMaterialPrice = validatedInputs.combinedMaterialPrice;
        const stonePrice = validatedInputs.stonePrice;
        const sacksPrice = validatedInputs.sacksPrice;
        const sandFayagePrice = validatedInputs.sandFayagePrice;

        const baseBuildArea = buildLength * buildWidth;
        if (baseBuildArea <= 0) throw new Error('Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø¨Ù†Ù‰ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
        const upperFloorArea = buildLength * (buildWidth + 1);
        const landArea = landLength * landWidth;
        const projectionArea = 10;

        const floorAreas = [baseBuildArea];
        let totalArea = baseBuildArea;
        for (let i = 1; i <= numFloors; i++) {
          floorAreas.push(upperFloorArea);
          totalArea += upperFloorArea;
        }
        const terraceArea = baseBuildArea * 0.4;
        totalArea += terraceArea;
        if (hasBasement) totalArea += (baseBuildArea + projectionArea);

        costData = [];

        // Excavation
        const excavationVolume = baseBuildArea * 3;
        const excavationCost = excavationVolume * excavationPrice;
        costData.push({
          material: 'Ø­ÙØ± Ø§Ù„Ø£Ø³Ø§Ø³Ø§Øª',
          stage: 'Ø§Ù„Ø£Ø³Ø§Ø³Ø§Øª',
          quantity: excavationVolume.toFixed(2),
          unit: 'Ù…Â³',
          unitPrice: excavationPrice,
          coveredArea: baseBuildArea,
          totalCost: excavationCost,
          costPerM2: baseBuildArea > 0 ? excavationCost / baseBuildArea : 0
        });

        // Iron
        const mainIronKg = getIronQuantity(baseBuildArea);
        let basementIronKg = 0;
        let totalIronKg = mainIronKg;
        if (hasBasement) {
          basementIronKg = getIronQuantity(baseBuildArea + projectionArea);
          totalIronKg += basementIronKg;
        }
        costData.push({
          material: 'Ø§Ù„Ø­Ø¯ÙŠØ¯',
          stage: 'ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (Ø¨Ø¯ÙˆÙ† Ù‚Ø¨Ùˆ)',
          quantity: mainIronKg.toFixed(2),
          unit: 'ÙƒØ¬Ù…',
          unitPrice: ironPrice,
          coveredArea: totalArea,
          totalCost: mainIronKg * ironPrice,
          costPerM2: totalArea > 0 ? (mainIronKg * ironPrice) / totalArea : 0
        });
        if (hasBasement) {
          costData.push({
            material: 'Ø§Ù„Ø­Ø¯ÙŠØ¯',
            stage: 'Ø§Ù„Ù‚Ø¨Ùˆ',
            quantity: basementIronKg.toFixed(2),
            unit: 'ÙƒØ¬Ù…',
            unitPrice: ironPrice,
            coveredArea: baseBuildArea + projectionArea,
            totalCost: basementIronKg * ironPrice,
            costPerM2: (baseBuildArea + projectionArea) > 0 ? (basementIronKg * ironPrice) / (baseBuildArea + projectionArea) : 0
          });
        }

        // Iron sizes (informational)
        const ironSizes = [
          { size: '6 Ù…Ù…', quantityKg: 1.50 },
          { size: '8 Ù…Ù…', quantityKg: 0.20 },
          { size: '10 Ù…Ù…', quantityKg: 3.50 },
          { size: '14 Ù…Ù…', quantityKg: 0.30 }
        ];
        ironSizes.forEach(({ size, quantityKg }) => {
          const scaledQuantity = (quantityKg * baseBuildArea / 120).toFixed(2);
          costData.push({
            material: `Ø§Ù„Ø­Ø¯ÙŠØ¯ ${size}`,
            stage: 'Ø§Ù„Ø·Ø¨Ù„Ø© (Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª)',
            quantity: scaledQuantity,
            unit: 'ÙƒØ¬Ù…',
            unitPrice: ironPrice,
            coveredArea: baseBuildArea,
            totalCost: 0,
            costPerM2: 0
          });
        });

        // Concrete (Beton)
        const semelleBeton = Math.ceil(semelleCount * 0.675);
        const dalleBeton = Math.ceil(baseBuildArea * 0.12);
        const terraceBeton = Math.ceil(terraceArea * 0.12);
        let basementBeton = 0;
        if (hasBasement) {
          basementBeton = Math.ceil((baseBuildArea + projectionArea) * 0.12);
        }
        costData.push({
          material: 'Ø§Ù„Ø¨ÙŠØªÙˆÙ†',
          stage: 'Ø§Ù„Ø£Ø³Ø§Ø³Ø§Øª (Semelle)',
          quantity: semelleBeton.toFixed(2),
          unit: 'Ù…Â³',
          unitPrice: betonPrice,
          coveredArea: baseBuildArea,
          totalCost: semelleBeton * betonPrice,
          costPerM2: baseBuildArea > 0 ? (semelleBeton * betonPrice) / baseBuildArea : 0
        });
        costData.push({
          material: 'Ø§Ù„Ø¨ÙŠØªÙˆÙ†',
          stage: 'Ø§Ù„Ø£Ø³Ø§Ø³Ø§Øª (Dalle)',
          quantity: dalleBeton.toFixed(2),
          unit: 'Ù…Â³',
          unitPrice: betonPrice,
          coveredArea: baseBuildArea,
          totalCost: dalleBeton * betonPrice,
          costPerM2: baseBuildArea > 0 ? (dalleBeton * betonPrice) / baseBuildArea : 0
        });
        const rdcBeton = Math.ceil(baseBuildArea * 0.12);
        costData.push({
          material: 'Ø§Ù„Ø¨ÙŠØªÙˆÙ†',
          stage: 'Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ (RDC)',
          quantity: rdcBeton.toFixed(2),
          unit: 'Ù…Â³',
          unitPrice: betonPrice,
          coveredArea: baseBuildArea,
          totalCost: rdcBeton * betonPrice,
          costPerM2: baseBuildArea > 0 ? (rdcBeton * betonPrice) / baseBuildArea : 0
        });
        for (let i = 1; i <= numFloors; i++) {
          const floorBeton = Math.ceil(upperFloorArea * 0.12);
//		  console.log("khalid:", `Ø§Ù„Ø·Ø§Ø¨Ù‚ ${i} (R+${i})`);
//		  console.log("floorBeton", floorBeton);
		  
          costData.push({
            material: 'Ø§Ù„Ø¨ÙŠØªÙˆÙ†',
            stage: `Ø§Ù„Ø·Ø§Ø¨Ù‚ ${i} (R+${i})`,
            quantity: floorBeton.toFixed(2),
            unit: 'Ù…Â³',
            unitPrice: betonPrice,
            coveredArea: upperFloorArea,
            totalCost: floorBeton * betonPrice,
            costPerM2: upperFloorArea > 0 ? (floorBeton * betonPrice) / upperFloorArea : 0
          });
        }
        costData.push({
          material: 'Ø§Ù„Ø¨ÙŠØªÙˆÙ†',
          stage: 'Ø§Ù„Ø³Ø·Ø­ (Terrace)',
          quantity: terraceBeton.toFixed(2),
          unit: 'Ù…Â³',
          unitPrice: betonPrice,
          coveredArea: terraceArea,
          totalCost: terraceBeton * betonPrice,
          costPerM2: terraceArea > 0 ? (terraceBeton * betonPrice) / terraceArea : 0
        });
	
		
        if (hasBasement) {
          costData.push({
            material: 'Ø§Ù„Ø¨ÙŠØªÙˆÙ†',
            stage: 'Ø§Ù„Ù‚Ø¨Ùˆ',
            quantity: basementBeton.toFixed(2),
            unit: 'Ù…Â³',
            unitPrice: betonPrice,
            coveredArea: baseBuildArea + projectionArea,
            totalCost: basementBeton * betonPrice,
            costPerM2: (baseBuildArea + projectionArea) > 0 ? (basementBeton * betonPrice) / (baseBuildArea + projectionArea) : 0
          });
        }

        // B15 Concrete
        const b15Beton = Math.ceil(semelleCount === 16 ? 11 : (11 * (semelleCount / 16)));
        const b15Cost = b15Beton * b15Price;
        costData.push({
          material: 'Ø®Ø±Ø³Ø§Ù†Ø© Ø§Ù„Ù†Ø¸Ø§ÙØ© B15',
          stage: 'Ø§Ù„Ø·Ø¨Ù„Ø©',
          quantity: b15Beton.toFixed(2),
          unit: 'Ù…Â³',
          unitPrice: b15Price,
          coveredArea: baseBuildArea,
          totalCost: b15Cost,
          costPerM2: baseBuildArea > 0 ? b15Cost / baseBuildArea : 0
        });

        // Cement
        const cementPerStage = {
          'Fondation': 92,
          'RDC': 85,
          'R+1': 85,
          'R+2': 85,
          'R+3': 85,
          'R+4': 85,
          'Terrace': 20,
          'Basement': 68
        };
        let totalCementBags = cementPerStage['Fondation'] * (baseBuildArea / 120);
        totalCementBags += cementPerStage['RDC'] * (baseBuildArea / 120);
        for (let i = 1; i <= numFloors; i++) {
          totalCementBags += cementPerStage[`R+${i}`] * (upperFloorArea / 120);
        }
        totalCementBags += cementPerStage['Terrace'] * (baseBuildArea / 120);
        if (hasBasement) totalCementBags += cementPerStage['Basement'] * (baseBuildArea / 120);
        costData.push({
          material: 'Ø§Ù„Ø£Ø³Ù…Ù†Øª',
          stage: 'Ø§Ù„Ø£Ø³Ø§Ø³Ø§Øª',
          quantity: (cementPerStage['Fondation'] * baseBuildArea / 120).toFixed(2),
          unit: 'Ø®Ù†Ø´Ø©',
          unitPrice: cementPrice,
          coveredArea: baseBuildArea,
          totalCost: (cementPerStage['Fondation'] * baseBuildArea / 120) * cementPrice,
          costPerM2: baseBuildArea > 0 ? ((cementPerStage['Fondation'] * baseBuildArea / 120) * cementPrice) / baseBuildArea : 0
        });
        costData.push({
          material: 'Ø§Ù„Ø£Ø³Ù…Ù†Øª',
          stage: 'Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ (RDC)',
          quantity: (cementPerStage['RDC'] * baseBuildArea / 120).toFixed(2),
          unit: 'Ø®Ù†Ø´Ø©',
          unitPrice: cementPrice,
          coveredArea: baseBuildArea,
          totalCost: (cementPerStage['RDC'] * baseBuildArea / 120) * cementPrice,
          costPerM2: baseBuildArea > 0 ? ((cementPerStage['RDC'] * baseBuildArea / 120) * cementPrice) / baseBuildArea : 0
        });
        for (let i = 1; i <= numFloors; i++) {
          costData.push({
            material: 'Ø§Ù„Ø£Ø³Ù…Ù†Øª',
            stage: `Ø§Ù„Ø·Ø§Ø¨Ù‚ ${i} (R+${i})`,
            quantity: (cementPerStage[`R+${i}`] * upperFloorArea / 120).toFixed(2),
            unit: 'Ø®Ù†Ø´Ø©',
            unitPrice: cementPrice,
            coveredArea: upperFloorArea,
            totalCost: (cementPerStage[`R+${i}`] * upperFloorArea / 120) * cementPrice,
            costPerM2: upperFloorArea > 0 ? ((cementPerStage[`R+${i}`] * upperFloorArea / 120) * cementPrice) / upperFloorArea : 0
          });
        }
        costData.push({
          material: 'Ø§Ù„Ø£Ø³Ù…Ù†Øª',
          stage: 'Ø§Ù„Ø³Ø·Ø­ (Terrace)',
          quantity: (cementPerStage['Terrace'] * baseBuildArea / 120).toFixed(2),
          unit: 'Ø®Ù†Ø´Ø©',
          unitPrice: cementPrice,
          coveredArea: terraceArea,
          totalCost: (cementPerStage['Terrace'] * baseBuildArea / 120) * cementPrice,
          costPerM2: terraceArea > 0 ? ((cementPerStage['Terrace'] * baseBuildArea / 120) * cementPrice) / terraceArea : 0
        });
		
		
	
		
        if (hasBasement) {
          costData.push({
            material: 'Ø§Ù„Ø£Ø³Ù…Ù†Øª',
            stage: 'Ø§Ù„Ù‚Ø¨Ùˆ',
            quantity: (cementPerStage['Basement'] * baseBuildArea / 120).toFixed(2),
            unit: 'Ø®Ù†Ø´Ø©',
            unitPrice: cementPrice,
            coveredArea: baseBuildArea + projectionArea,
            totalCost: (cementPerStage['Basement'] * baseBuildArea / 120) * cementPrice,
            costPerM2: (baseBuildArea + projectionArea) > 0 ? ((cementPerStage['Basement'] * baseBuildArea / 120) * cementPrice) / (baseBuildArea + projectionArea) : 0
          });
        }

        // Gravel
        const gravelVolume = (25 * baseBuildArea) / 120;
        const gravelCost = gravelVolume * gravelPrice;
        costData.push({
          material: 'Ø­ØµÙ‰ Ø§Ù„ÙÙŠØ§Ø¬',
          stage: 'Ø§Ù„Ø£Ø³Ø§Ø³Ø§Øª',
          quantity: gravelVolume.toFixed(2),
          unit: 'Ù…Â³',
          unitPrice: gravelPrice,
          coveredArea: baseBuildArea,
          totalCost: gravelCost,
          costPerM2: baseBuildArea > 0 ? gravelCost / baseBuildArea : 0
        });

        // Bricks
        const mainBricks = (4000 * baseBuildArea) / 120;
        const partitionBricks = (5000 * baseBuildArea) / 120;
        const totalBricks = mainBricks + partitionBricks;
        const brickCost = totalBricks * brickPrice;
        costData.push({
          material: 'Ø§Ù„Ø·ÙˆØ¨',
          stage: 'ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹',
          quantity: totalBricks.toFixed(2),
          unit: 'Ø­Ø¨Ø©',
          unitPrice: brickPrice,
          coveredArea: totalArea,
          totalCost: brickCost,
          costPerM2: totalArea > 0 ? brickCost / totalArea : 0
        });

        // Sand
        const sandVolume = (25 * baseBuildArea) / 120;
        const sandCost = sandVolume * sandPrice;
        costData.push({
          material: 'Ø±Ù…Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡',
          stage: 'ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹',
          quantity: sandVolume.toFixed(2),
          unit: 'Ù…Â³',
          unitPrice: sandPrice,
          coveredArea: totalArea,
          totalCost: sandCost,
          costPerM2: totalArea > 0 ? sandCost / totalArea : 0
        });

        // Aggregate
        const aggregateVolume = (25 * baseBuildArea) / 120;
        const aggregateCost = aggregateVolume * aggregatePrice;
        costData.push({
          material: 'Ø§Ù„Ø­ØµÙ‰',
          stage: 'ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹',
          quantity: aggregateVolume.toFixed(2),
          unit: 'Ù…Â³',
          unitPrice: aggregatePrice,
          coveredArea: totalArea,
          totalCost: aggregateCost,
          costPerM2: totalArea > 0 ? aggregateCost / totalArea : 0
        });

        // Labor
        const laborPerStage = 100;
        let totalLaborCost = laborPerStage * baseBuildArea;
        totalLaborCost += laborPerStage * baseBuildArea;
        for (let i = 1; i <= numFloors; i++) {
          totalLaborCost += laborPerStage * upperFloorArea;
        }
        totalLaborCost += laborPerStage * terraceArea;
        if (hasBasement) totalLaborCost += laborPerStage * (baseBuildArea + projectionArea);
        totalLaborCost *= laborPrice / 100;
        costData.push({
          material: 'Ø§Ù„ÙŠØ¯ Ø§Ù„Ø¹Ø§Ù…Ù„Ø©',
          stage: 'Ø§Ù„Ø£Ø³Ø§Ø³Ø§Øª',
          quantity: baseBuildArea.toFixed(2),
          unit: 'Ù…Â²',
          unitPrice: laborPrice,
          coveredArea: baseBuildArea,
          totalCost: laborPerStage * baseBuildArea * (laborPrice / 100),
          costPerM2: laborPerStage * (laborPrice / 100)
        });
        costData.push({
          material: 'Ø§Ù„ÙŠØ¯ Ø§Ù„Ø¹Ø§Ù…Ù„Ø©',
          stage: 'Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ (RDC)',
          quantity: baseBuildArea.toFixed(2),
          unit: 'Ù…Â²',
          unitPrice: laborPrice,
          coveredArea: baseBuildArea,
          totalCost: laborPerStage * baseBuildArea * (laborPrice / 100),
          costPerM2: laborPerStage * (laborPrice / 100)
        });
        for (let i = 1; i <= numFloors; i++) {
          costData.push({
            material: 'Ø§Ù„ÙŠØ¯ Ø§Ù„Ø¹Ø§Ù…Ù„Ø©',
            stage: `Ø§Ù„Ø·Ø§Ø¨Ù‚ ${i} (R+${i})`,
            quantity: upperFloorArea.toFixed(2),
            unit: 'Ù…Â²',
            unitPrice: laborPrice,
            coveredArea: upperFloorArea,
            totalCost: laborPerStage * upperFloorArea * (laborPrice / 100),
            costPerM2: laborPerStage * (laborPrice / 100)
          });
        }
        costData.push({
          material: 'Ø§Ù„ÙŠØ¯ Ø§Ù„Ø¹Ø§Ù…Ù„Ø©',
          stage: 'Ø§Ù„Ø³Ø·Ø­ (Terrace)',
          quantity: terraceArea.toFixed(2),
          unit: 'Ù…Â²',
          unitPrice: laborPrice,
          coveredArea: terraceArea,
          totalCost: laborPerStage * terraceArea * (laborPrice / 100),
          costPerM2: laborPerStage * (laborPrice / 100)
        });
        if (hasBasement) {
          costData.push({
            material: 'Ø§Ù„ÙŠØ¯ Ø§Ù„Ø¹Ø§Ù…Ù„Ø©',
            stage: 'Ø§Ù„Ù‚Ø¨Ùˆ',
            quantity: (baseBuildArea + projectionArea).toFixed(2),
            unit: 'Ù…Â²',
            unitPrice: laborPrice,
            coveredArea: baseBuildArea + projectionArea,
            totalCost: laborPerStage * (baseBuildArea + projectionArea) * (laborPrice / 100),
            costPerM2: laborPerStage * (laborPrice / 100)
          });
        }

        // Combined Material
        costData.push({
          material: 'Ø§Ù„ÙˆØ±Ø¯ÙŠ ÙˆØ§Ù„Ø¨ÙˆØ¯Ø± ÙˆØ§Ù„Ø´Ø¨ÙƒØ©',
          stage: 'ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹',
          quantity: totalArea.toFixed(2),
          unit: 'Ù…Â²',
          unitPrice: combinedMaterialPrice,
          coveredArea: totalArea,
          totalCost: totalArea * combinedMaterialPrice,
          costPerM2: combinedMaterialPrice
        });

        // Additional Materials
        const fayageQuantity = (baseBuildArea / 25).toFixed(2);
        costData.push({
          material: 'Ø§Ù„Ø­Ø¬Ø± (Ù„Ù„Ø¨Ù„ÙˆÙƒØ§Ø¬)',
          stage: 'ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹',
          quantity: fayageQuantity,
          unit: 'ÙÙŠØ§Ø¬',
          unitPrice: stonePrice,
          coveredArea: baseBuildArea,
          totalCost: fayageQuantity * stonePrice,
          costPerM2: baseBuildArea > 0 ? (fayageQuantity * stonePrice) / baseBuildArea : 0
        });
        costData.push({
          material: 'Ø§Ù„ÙƒÙŠØ§Ø³',
          stage: 'ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹',
          quantity: fayageQuantity,
          unit: 'ÙÙŠØ§Ø¬',
          unitPrice: sacksPrice,
          coveredArea: baseBuildArea,
          totalCost: fayageQuantity * sacksPrice,
          costPerM2: baseBuildArea > 0 ? (fayageQuantity * sacksPrice) / baseBuildArea : 0
        });
        costData.push({
          material: 'Ø§Ù„Ø±Ù…Ù„',
          stage: 'ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹',
          quantity: fayageQuantity,
          unit: 'ÙÙŠØ§Ø¬',
          unitPrice: sandFayagePrice,
          coveredArea: baseBuildArea,
          totalCost: fayageQuantity * sandFayagePrice,
          costPerM2: baseBuildArea > 0 ? (fayageQuantity * sandFayagePrice) / baseBuildArea : 0
        });

        document.getElementById('costOutput').classList.remove('hidden');
        updateTables();
      } catch (error) {
        console.error('Error in calculateCost:', {
          message: error.message,
          stack: error.stack,
          inputs: {
            landLength: document.getElementById('landLength').value,
            landWidth: document.getElementById('landWidth').value,
            buildLength: document.getElementById('buildLength').value,
            buildWidth: document.getElementById('buildWidth').value,
            numFloors: document.getElementById('numFloors').value,
            semelleCount: document.getElementById('semelleCount').value
          }
        });
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚ÙŠÙ… ØµØ­ÙŠØ­Ø©.');
      }
    }

    // Update unit price in costData
    function updateUnitPrice(index, newPrice) {
      try {
        const price = getValidNumber(newPrice, 0);
        if (price < 0) {
          showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± ÙˆØ­Ø¯Ø© ØµØ§Ù„Ø­ ÙˆÙ…ÙˆØ¬Ø¨');
          return;
        }
        costData[index].unitPrice = price;
        costData[index].totalCost = parseFloat(costData[index].quantity) * costData[index].unitPrice;
        costData[index].costPerM2 = costData[index].coveredArea > 0 ? costData[index].totalCost / costData[index].coveredArea : 0;
        if (costData[index].stage.includes('Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª')) {
          costData[index].totalCost = 0;
          costData[index].costPerM2 = 0;
        }
        clearError();
        updateTables();
      } catch (error) {
        console.error('Error in updateUnitPrice:', error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©.');
      }
    }

    // Update quantity in costData
    function updateQuantity(index, newQuantity) {
      try {
        const quantity = getValidNumber(newQuantity, 0);
        if (quantity < 0) {
          showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ§Ù„Ø­Ø© ÙˆÙ…ÙˆØ¬Ø¨Ø©');
          return;
        }
        costData[index].quantity = quantity.toFixed(2);
        costData[index].totalCost = parseFloat(costData[index].quantity) * costData[index].unitPrice;
        costData[index].costPerM2 = costData[index].coveredArea > 0 ? costData[index].totalCost / costData[index].coveredArea : 0;
        if (costData[index].stage.includes('Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª')) {
          costData[index].totalCost = 0;
          costData[index].costPerM2 = 0;
        }
        clearError();
        updateTables();
      } catch (error) {
        console.error('Error in updateQuantity:', error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ©.');
      }
    }


    function exportToPDF() {
      const element = document.getElementById('costOutput');
      const inputsSummary = `
        <div class="mb-4">
          <h2 class="text-xl font-semibold">Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª</h2>
          <p>Ø·ÙˆÙ„ Ø§Ù„Ø£Ø±Ø¶: ${document.getElementById('landLength').value || 10} Ù…</p>
          <p>Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø¶: ${document.getElementById('landWidth').value || 12} Ù…</p>
          <p>Ø·ÙˆÙ„ Ø§Ù„Ù…Ø¨Ù†Ù‰: ${document.getElementById('buildLength').value || 12} Ù…</p>
          <p>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ù†Ù‰: ${document.getElementById('buildWidth').value || 12} Ù…</p>
          <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚: ${document.getElementById('numFloors').value || 1}</p>
          <p>ÙˆØ¬ÙˆØ¯ Ù‚Ø¨Ùˆ: ${document.getElementById('hasBasement').checked ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}</p>
        </div>
      `;
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = inputsSummary + element.outerHTML;
      html2pdf().from(tempDiv).save('cost_estimation.pdf');
    }

    function exportToExcel() {
      const costTable = document.getElementById('costTableBody');
      const summaryTable = document.getElementById('summaryTableBody');
      const wb = XLSX.utils.book_new();
      const costRows = costTable.getElementsByTagName('tr');
      const costData = [['Ø§Ù„Ù…Ø§Ø¯Ø©', 'Ø§Ù„Ù…Ø±Ø­Ù„Ø©', 'Ø§Ù„ÙƒÙ…ÙŠØ©', 'Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØºØ·Ø§Ø© (Ù…Â²)', 'Ø§Ù„ØªÙƒÙ„ÙØ© Ù„ÙƒÙ„ ÙˆØ­Ø¯Ø© (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ)', 'Ø§Ù„ØªÙƒÙ„ÙØ© (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ)', 'Ø§Ù„ØªÙƒÙ„ÙØ© Ù„ÙƒÙ„ Ù…Â² (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ)']];
      for (let row of costRows) {
        const cells = row.getElementsByTagName('td');
        costData.push([
          cells[0].textContent,
          cells[1].textContent,
          cells[2].getElementsByTagName('input')[0].value,
          cells[3].textContent,
          cells[4].getElementsByTagName('input')[0].value,
          cells[5].textContent,
          cells[6].textContent
        ]);
      }
      const costWs = XLSX.utils.aoa_to_sheet(costData);
      XLSX.utils.book_append_sheet(wb, costWs, 'Detailed Cost');
      const summaryRows = summaryTable.getElementsByTagName('tr');
      const summaryData = [['Ø§Ù„Ù…Ø§Ø¯Ø©', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ© (Ø¯Ø±Ù‡Ù… Ù…ØºØ±Ø¨ÙŠ)', 'Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© (%)']];
      for (let row of summaryRows) {
        const cells = row.getElementsByTagName('td');
        summaryData.push([
          cells[0].textContent,
          cells[1].textContent,
          cells[2].textContent,
          cells[3].textContent
        ]);
      }
      const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary by Product');
      XLSX.writeFile(wb, 'cost_estimation.xlsx');
    }
  </script>
</body>
</html>		  

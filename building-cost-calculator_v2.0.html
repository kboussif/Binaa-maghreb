<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø­Ø§Ø³Ø¨Ø© ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ù†Ø§Ø¡ - Ù†Ø³Ø®Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©</title>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: 'Amiri', 'Noto Sans Arabic', sans-serif; background: #f4e7d3; color: #3c2f2f; padding: 20px; }
    .container { max-width: 1200px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; }
    h1, h2, h3 { color: #004aad; }
    input, button, select { padding: 6px; margin: 4px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #d4a373; padding: 8px; text-align: center; }
    .admin-panel { background: #ede7f6; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: none; }
    .toggle-admin { background: #004aad; color: white; padding: 8px; border: none; cursor: pointer; margin:8px 0; }
    .admin-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .admin-row input, .admin-row select { min-width:140px; }
    .admin-block { margin-bottom:10px; }
    .small { width:120px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h1> Ø­Ø§Ø³Ø¨Ø© ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ù†Ø§Ø¡ - Ù†Ø³Ø®Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©  v2.02 date 13-aug-25 8AM</h1>
    <!-- Project Inputs -->
    <div>
      <label>Ø·ÙˆÙ„ Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ù…):</label><input type="number" id="buildLength" value="10">
      <label>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ù…):</label><input type="number" id="buildWidth" value="10">
      <div style="display:none;">
        <label>Ø·ÙˆÙ„ Ø§Ù„Ø£Ø±Ø¶ (Ù…):</label><input type="number" id="landLength" value="10">
        <label>Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø¶ (Ù…):</label><input type="number" id="landWidth" value="10">
      </div>
      <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚:</label><input type="number" id="numFloors" value="3" min="1">
      <label>ÙˆØ¬ÙˆØ¯ Ù‚Ø¨Ùˆ:</label><input type="checkbox" id="hasBasement">
      <button onclick="calculateCost()">Ø§Ø­Ø³Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ©</button>
    </div>
    <!-- Toggle Admin Tools -->
    <button class="toggle-admin" onclick="document.querySelector('.admin-panel').style.display =
        document.querySelector('.admin-panel').style.display==='none' ? 'block' : 'none'">
      âš™ï¸ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
    </button>
    <!-- Admin Panel -->
    <div class="admin-panel">
      <h3>Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
      <!-- Add Section -->
      <div class="admin-block admin-row">
        <label for="newSectionName" style="margin-left:8px;">Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:</label>
        <input id="newSectionName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
        <button onclick="addSection()">â• Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</button>
      </div>
      <!-- Rename / Delete Section -->
      <div class="admin-block admin-row">
        <label for="sectionSelect" style="margin-left:8px;">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…:</label>
        <select id="sectionSelect" class="small"></select>
        <label for="renameSectionName" style="margin-left:8px;">Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù‚Ø³Ù…:</label>
        <input id="renameSectionName" placeholder="Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù‚Ø³Ù…">
        <button onclick="renameSection()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…</button>
        <button onclick="deleteSection()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…</button>
      </div>
      <!-- Items Management -->
      <div class="admin-block">
        <div class="admin-row">
          <label for="sectionForItem" style="margin-left:8px;">Ø§Ù„Ù‚Ø³Ù…:</label>
          <select id="sectionForItem" class="small"></select>
          <label for="itemList" style="margin-left:8px;">Ø§Ù„Ø¨Ù†Ø¯:</label>
          <select id="itemList" class="small"></select>
        </div>
        <div class="admin-row" style="margin-top:8px;">
          <label for="itemName" style="margin-left:8px;">Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯:</label>
          <input id="itemName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯" style="flex:1;">
          <label for="itemUnit" style="margin-left:8px;">Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
          <input id="itemUnit" placeholder="Ø§Ù„ÙˆØ­Ø¯Ø© (Ù…Ø«Ø§Ù„: 1 Ø£Ùˆ 100)" class="small">
          <label for="itemPrice" style="margin-left:8px;">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
          <input type="number" id="itemPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©" class="small">
          <label for="itemQty" style="margin-left:8px;">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:</label>
          <input type="number" id="itemQty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©" class="small">
        </div>
        <div class="admin-row" style="margin-top:8px;">
          <button onclick="addItem()">â• Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</button>
          <button onclick="updateItem()">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button onclick="deleteItem()">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </div>
      </div>
      <!-- Export / Import -->
      <div class="admin-block admin-row">
        <button onclick="exportModel()">ğŸ’¾ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (JSON)</button>
        <input type="file" id="importFile" onchange="importModel(event)">
      </div>
    </div>
    <!-- Cost Output -->
    <div id="costOutput"></div>
    <!-- Export Buttons -->
    <div style="margin-top:8px;">
      <button onclick="exportToPDF()">ğŸ“„ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF</button>
      <button onclick="exportAllToExcel('Ø§Ù„ØªÙƒÙ„ÙØ©.xlsx')">ğŸ“Š ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
    </div>
  </div>
  <script>
    /* ---------- Config & state ---------- */
    const LOG_ENABLED = true;
    let baseData = [];
    let lastSectionIdx = null;
    let lastItemIdx = null;

    /* ---------- Default model for 3 floors + basement ---------- */
    const fallbackModel = [
      {
        "name": "Ø§Ù„Ø£Ø³Ø§Ø³Ø§Øª",
        "items": [
          { "item": "Ø­ÙØ± Ø§Ù„Ø£Ø³Ø§Ø³Ø§Øª", "unit": "100", "unitPrice": 30, "baseQty": 100 }
         ]
      },
      {
        "name": "Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ RDC",
        "items": [
         { "item": "Ø­ÙØ± Ø§Ù„Ø£Ø³Ø§Ø³Ø§Øª", "unit": "100", "unitPrice": 125, "baseQty": 100 },
          { "item": "Ø§Ù„ÙŠØ¯ Ø§Ù„Ø¹Ø§Ù…Ù„Ø©", "unit": "100", "unitPrice": 125, "baseQty": 100 }
        ]
      },
      {
        "name": "R+1 Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„",
        "items": [
          { "item": "Ø­ÙØ± Ø§Ù„Ø£Ø³Ø§Ø³Ø§Øª", "unit": "100", "unitPrice": 125, "baseQty": 100 },
          { "item": "Ø§Ù„ÙŠØ¯ Ø§Ù„Ø¹Ø§Ù…Ù„Ø©", "unit": "100", "unitPrice": 125, "baseQty": 100 }
        ]
      },
      {
        "name": "R+2 Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ",
        "items": [
          { "item": "Ø­ÙØ± Ø§Ù„Ø£Ø³Ø§Ø³Ø§Øª", "unit": "100", "unitPrice": 125, "baseQty": 100 },
          { "item": "Ø§Ù„ÙŠØ¯ Ø§Ù„Ø¹Ø§Ù…Ù„Ø©", "unit": "100", "unitPrice": 125, "baseQty": 100 }
        ]
      },
      {
        "name": "R+T Ø§Ù„Ø³Ø·Ø­",
        "items": [
          { "item": "Ø­ÙØ± Ø§Ù„Ø£Ø³Ø§Ø³Ø§Øª", "unit": "100", "unitPrice": 125, "baseQty": 100 },
          { "item": "Ø§Ù„Ø­Ø¯ÙŠØ¯ (6 Ù…Ù…)", "unit": "100", "unitPrice": 9.4, "baseQty": 400 },
          { "item": "Ø§Ù„Ø­Ø¯ÙŠØ¯ (10 Ù…Ù…)", "unit": "100", "unitPrice": 9.2, "baseQty": 500 },
            { "item": "Ù…ÙŠÙƒØ§", "unit": "100", "unitPrice": 20, "baseQty": 65 },
          { "item": "Ø§Ù„Ù…Ø§Ø¡ ÙˆØ§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ (Ù…ÙˆØ§Ø¯)", "unit": "100", "unitPrice": 70, "baseQty": 0 },
          { "item": "Ø§Ù„Ù…Ø§Ø¡ ÙˆØ§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ (ÙŠØ¯ Ø¹Ø§Ù…Ù„Ø©)", "unit": "100", "unitPrice": 45, "baseQty": 0 },
          { "item": "Ø§Ù„ÙŠØ¯ Ø§Ù„Ø¹Ø§Ù…Ù„Ø©", "unit": "100", "unitPrice": 125, "baseQty": 100 }
        ]
      }
    ];


/* ---------- Load default model   ---------- */
async function loadDefaultData() {
  try {
//    const url = 'https://raw.githubusercontent.com/kboussif/Binaa-maghreb/main/model/R+3_1Facade';


    const url = 'https://raw.githubusercontent.com/kboussif/Binaa-maghreb/main/Binaa_mabgreb_defaultDataV1.json';
	
    const res = await fetch(url);
    if (!res.ok) throw new Error('Failed to fetch remote JSON, using fallback');
    baseData = await res.json();
    if (!Array.isArray(baseData) || baseData.length === 0) throw new Error('Invalid JSON, using fallback');
    console.log('Loaded model from GitHub');
  } catch (err) {
    console.warn(err);
    baseData = JSON.parse(JSON.stringify(fallbackModel)); // deep copy
    console.log('Using fallback model');
  }

  refreshSectionSelects();
//  initialize selection defaults
  const secSel = document.getElementById('sectionForItem');
  if (secSel.options.length > 0) secSel.selectedIndex = 0;

   populateItemList();

  // set last selection
  lastSectionIdx = secSel.value || null;
  const itSel = document.getElementById('itemList');
  if (itSel.options.length > 0) itSel.selectedIndex = 0;
  lastItemIdx = itSel.value || null;
  loadItemDetails(); // fill form with first item
   calculateCost();
 
}


    /* ---------- UI population ---------- */
    function refreshSectionSelects() {
      const selects = [document.getElementById('sectionSelect'), document.getElementById('sectionForItem')];
      selects.forEach(sel => {
        sel.innerHTML = '';
        baseData.forEach((sec, idx) => {
          const opt = document.createElement('option');
          opt.value = idx;
          opt.textContent = sec.name || `Ù‚Ø³Ù… ${idx + 1}`;
          sel.appendChild(opt);
        });
      });
    }

    function populateItemList() {
      const sectionIdx = Number(document.getElementById('sectionForItem').value) || 0;
      const itemList = document.getElementById('itemList');
      itemList.innerHTML = '';
      if (!baseData[sectionIdx] || !Array.isArray(baseData[sectionIdx].items)) {
        console.warn('No items found for section ' + sectionIdx);
        return;
      }
      baseData[sectionIdx].items.forEach((it, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = it.item || `Ø¨Ù†Ø¯ ${idx + 1}`;
        itemList.appendChild(opt);
      });
      if (itemList.options.length > 0) {
        itemList.selectedIndex = 0;
        lastItemIdx = itemList.value;
      } else {
        lastItemIdx = null;
      }
    }

    /* ---------- Helpers to autosave pending edits ---------- */
    function getCurrentFormValues() {
      return {
        item: document.getElementById('itemName').value.trim() || '',
        unit: document.getElementById('itemUnit').value.trim() || '1',
        unitPrice: parseFloat(document.getElementById('itemPrice').value) || 0,
        baseQty: parseFloat(document.getElementById('itemQty').value) || 0
      };
    }

    function savePendingEditsIfAny(oldSecIdx, oldItIdx) {
      if (oldSecIdx == null || oldItIdx == null) return;
      oldSecIdx = Number(oldSecIdx);
      oldItIdx = Number(oldItIdx);
      if (!baseData[oldSecIdx] || !baseData[oldSecIdx].items[oldItIdx]) return;

      const current = baseData[oldSecIdx].items[oldItIdx];
      const form = getCurrentFormValues();

      const changed = current.item !== form.item ||
                     current.unit !== form.unit ||
                     Number(current.unitPrice) !== Number(form.unitPrice) ||
                     Number(current.baseQty) !== Number(form.baseQty);

      if (changed) {
        baseData[oldSecIdx].items[oldItIdx] = {
          item: form.item,
          unit: form.unit,
          unitPrice: form.unitPrice,
          baseQty: form.baseQty
        };
        logRow(`Auto-saved edits for section ${oldSecIdx}, item ${oldItIdx}`);
        populateItemList();
        document.getElementById('itemList').value = String(oldItIdx);
        calculateCost();
      }
    }

    function loadItemDetails() {
      const sectionIdx = Number(document.getElementById('sectionForItem').value) || 0;
      const itemIdx = Number(document.getElementById('itemList').value) || 0;

      if (lastSectionIdx !== null || lastItemIdx !== null) {
        if (String(sectionIdx) !== String(lastSectionIdx) || String(itemIdx) !== String(lastItemIdx)) {
          savePendingEditsIfAny(lastSectionIdx, lastItemIdx);
        }
      }

      lastSectionIdx = sectionIdx;
      lastItemIdx = itemIdx;

      if (!baseData[sectionIdx] || !baseData[sectionIdx].items[itemIdx]) {
        document.getElementById('itemName').value = '';
        document.getElementById('itemUnit').value = '';
        document.getElementById('itemPrice').value = '';
        document.getElementById('itemQty').value = '';
        return;
      }

      const it = baseData[sectionIdx].items[itemIdx];
      document.getElementById('itemName').value = it.item || '';
      document.getElementById('itemUnit').value = it.unit || '';
      document.getElementById('itemPrice').value = it.unitPrice != null ? it.unitPrice : '';
      document.getElementById('itemQty').value = it.baseQty != null ? it.baseQty : '';
    }

    /* ---------- CRUD operations ---------- */
    function addSection() {
      const name = document.getElementById('newSectionName').value.trim();
      if (!name) {
        alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…');
        return;
      }
      baseData.push({ name, items: [] });
      refreshSectionSelects();
      const secSel = document.getElementById('sectionForItem');
      secSel.value = String(baseData.length - 1);
      populateItemList();
      lastSectionIdx = secSel.value;
      lastItemIdx = null;
      calculateCost();
    }

    function renameSection() {
      const idx = Number(document.getElementById('sectionSelect').value);
      const name = document.getElementById('renameSectionName').value.trim();
      if (isNaN(idx) || !baseData[idx]) {
        alert('Ø§Ø®ØªØ± Ù‚Ø³Ù…Ù‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§');
        return;
      }
      if (!name) {
        alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯');
        return;
      }
      baseData[idx].name = name;
      refreshSectionSelects();
      populateItemList();
      calculateCost();
    }

    function deleteSection() {
      const idx = Number(document.getElementById('sectionSelect').value);
      if (isNaN(idx) || !baseData[idx]) {
        alert('Ø§Ø®ØªØ± Ù‚Ø³Ù…Ù‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§');
        return;
      }
      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…ØŸ')) return;
      baseData.splice(idx, 1);
      refreshSectionSelects();
      populateItemList();
      calculateCost();
    }

    function addItem() {
      const secIdx = Number(document.getElementById('sectionForItem').value);
      if (isNaN(secIdx) || !baseData[secIdx]) {
        alert('Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      const newItem = getCurrentFormValues();
      if (!newItem.item) {
        alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯');
        return;
      }
      baseData[secIdx].items.push(newItem);
      populateItemList();
      document.getElementById('itemList').value = String(baseData[secIdx].items.length - 1);
      lastSectionIdx = secIdx;
      lastItemIdx = document.getElementById('itemList').value;
      calculateCost();
    }

    function updateItem() {
      const sectionIdx = Number(document.getElementById('sectionForItem').value);
      const itemIdx = Number(document.getElementById('itemList').value);

      // Validate inputs
      if (isNaN(sectionIdx) || isNaN(itemIdx)) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø³Ù… ÙˆØ¨Ù†Ø¯ ØµØ§Ù„Ø­ÙŠÙ†');
        return;
      }
      if (!baseData[sectionIdx] || !baseData[sectionIdx].items[itemIdx]) {
        alert('Ø§Ù„Ù‚Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ù†Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        return;
      }

      // Get form values
      const newItem = getCurrentFormValues();
      if (!newItem.item) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯');
        return;
      }

      // Update the item in baseData
      baseData[sectionIdx].items[itemIdx] = {
        item: newItem.item,
        unit: newItem.unit,
        unitPrice: newItem.unitPrice,
        baseQty: newItem.baseQty
      };

      // Log for debugging
      logRow(`Updated item in section ${sectionIdx}, item ${itemIdx}: ${JSON.stringify(baseData[sectionIdx].items[itemIdx])}`);
    if (!confirm('we were to refresh ')) return;

      // Update UI
      populateItemList();
//      document.getElementById('itemList').value = String(itemIdx);
    document.getElementById('itemList').value = itemIdx;
      loadItemDetails();
      calculateCost();
    }




    function deleteItem() {
      const secIdx = Number(document.getElementById('sectionForItem').value);
      const itIdx = Number(document.getElementById('itemList').value);
      if (isNaN(secIdx) || isNaN(itIdx) || !baseData[secIdx] || !baseData[secIdx].items[itIdx]) {
        alert('Ø§Ø®ØªØ± Ù‚Ø³Ù…Ù‹Ø§ ÙˆØ¨Ù†Ø¯Ù‹Ø§ ØµØ§Ù„Ø­ÙŠÙ†');
        return;
      }
      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ØŸ')) return;
      baseData[secIdx].items.splice(itIdx, 1);
      populateItemList();
      const itemList = document.getElementById('itemList');
      if (itemList.options.length) itemList.selectedIndex = 0;
      lastItemIdx = itemList.value || null;
      loadItemDetails();
      calculateCost();
    }




//****  calculateCost 

function calculateCost() {
  let html = '';

  // 1ï¸âƒ£ Get the input values
  let buildLength = parseFloat(document.getElementById('buildLength').value) || 0;
  let buildWidth = parseFloat(document.getElementById('buildWidth').value) || 0;
  let numFloors = parseFloat(document.getElementById('numFloors').value) || 1;
  let hasBasement = document.getElementById('hasBasement').checked;

  // 2ï¸âƒ£ Calculate total building area (floors + basement if any)
  let buildArea = buildLength * buildWidth;
  let totalArea = buildLength * buildWidth
//  let totalArea = buildArea * numFloors;
// if (hasBasement) totalArea += buildArea;

  // 3ï¸âƒ£ Track the grand total
  let grandTotal = 0;

  // 4ï¸âƒ£ Loop through each section
  baseData.forEach(section => {
    let sectionTotal = 0;
    html += `<h3>${section.name}</h3><table><thead><tr>
      <th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
    </tr></thead><tbody>`;

    section.items.forEach(item => {
      // Convert unit string to number (e.g., "100" means base area of 100m2)
      let baseUnitArea = parseFloat(item.unit) || 1;

      // Scale baseQty by ratio of actual totalArea to baseUnitArea
      let adjustedQty = (totalArea / baseUnitArea) * item.baseQty;

      // Calculate item total cost
      let itemTotal = adjustedQty * item.unitPrice;
      sectionTotal += itemTotal;

      html += `<tr>
        <td>${item.item}</td>
        <td>${item.unit}</td>
        <td>${adjustedQty.toFixed(2)}</td>
        <td>${item.unitPrice.toFixed(2)}</td>
        <td>${itemTotal.toFixed(2)}</td>
      </tr>`;
    });

    grandTotal += sectionTotal;

    html += `<tr><td colspan="4"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</strong></td><td><strong>${sectionTotal.toFixed(2)}</strong></td></tr></tbody></table>`;
  });

  // 5ï¸âƒ£ Display grand total
  let grandTotalHtml = `<h2 style="color: red;">ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: ${grandTotal.toFixed(2)}</h2>`;
  document.getElementById('costOutput').innerHTML = grandTotalHtml + html;
  document.getElementById('costOutput').style.display = 'block'; // make sure it's visible
}


/* ---------- Calculation ---------- */
function v2_calculateCost() {
  let html = '';
  let grandTotal = 0;

  // 1ï¸âƒ£ Get input values
  let buildLength = parseFloat(document.getElementById('buildLength').value) || 0;
  let buildWidth = parseFloat(document.getElementById('buildWidth').value) || 0;
  let numFloors = parseInt(document.getElementById('numFloors').value) || 1;
  let hasBasement = document.getElementById('hasBasement').checked;

  // 2ï¸âƒ£ Calculate building area per floor
  let buildArea = buildLength * buildWidth;

  // 3ï¸âƒ£ Select sections based on user input
  const selectedSections = [];
  if (hasBasement && baseData[0]) selectedSections.push(baseData[0]); // Foundation
  if ( baseData[0]) selectedSections.push(baseData[0]); // Foundation

  if (baseData[1]) selectedSections.push(baseData[1]); // Ground Floor
  if (numFloors >= 1 && baseData[2]) selectedSections.push(baseData[2]); // First Floor
  if (numFloors >= 2 && baseData[3]) selectedSections.push(baseData[3]); // Second Floor
  if (baseData[4]) selectedSections.push(baseData[4]); // Roof

  // 4ï¸âƒ£ Log inputs for debugging
  logRow(`Inputs: buildLength=${buildLength}, buildWidth=${buildWidth}, numFloors=${numFloors}, hasBasement=${hasBasement}, buildArea=${buildArea}`);
  logRow('Selected sections:', selectedSections.map(s => s ? s.name : 'undefined'));

  // 5ï¸âƒ£ Process each selected section
  selectedSections.forEach(section => {
    let sectionTotal = 0;
    html += `<h3>${escapeHtml(section.name)}</h3><table><thead><tr>
      <th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
    </tr></thead><tbody>`;

    section.items.forEach(item => {
      let baseUnitArea = parseFloat(item.unit) || 1;
      let adjustedQty = (buildArea / baseUnitArea) * item.baseQty;
      let itemTotal = adjustedQty * item.unitPrice;
      sectionTotal += itemTotal;

      html += `<tr>
        <td>${escapeHtml(item.item)}</td>
        <td>${escapeHtml(item.unit)}</td>
        <td>${adjustedQty.toFixed(2)}</td>
        <td>${item.unitPrice.toFixed(2)}</td>
        <td>${itemTotal.toFixed(2)}</td>
      </tr>`;
    });

    grandTotal += sectionTotal;
    html += `<tr><td colspan="4"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</strong></td><td><strong>${sectionTotal.toFixed(2)}</strong></td></tr></tbody></table>`;
  });

  // 6ï¸âƒ£ Check if table is empty
  if (!html) {
    document.getElementById('costOutput').innerHTML = '<p style="color: red;">Ø®Ø·Ø£: Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„</p>';
    logRow('Error: No valid items to display in table');
    return;
  }

  // 7ï¸âƒ£ Display grand total
  let grandTotalHtml = `<h2 style="color: red;">ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: ${grandTotal.toFixed(2)}</h2>`;
  document.getElementById('costOutput').innerHTML = grandTotalHtml + html;
  document.getElementById('costOutput').style.display = 'block';

  // Log generated HTML for debugging
  logRow('Generated HTML:', grandTotalHtml + html);
}



function old_calculateCost() {
  let html = '';

  // 1ï¸âƒ£ Get the input values
  let buildLength = parseFloat(document.getElementById('buildLength').value) || 0;
  let buildWidth = parseFloat(document.getElementById('buildWidth').value) || 0;
  let numFloors = parseFloat(document.getElementById('numFloors').value) || 1;
  let hasBasement = document.getElementById('hasBasement').checked;

  // 2ï¸âƒ£ Calculate total building area (floors + basement if any)
  let buildArea = buildLength * buildWidth;
  let totalArea = buildLength * buildWidth
//  let totalArea = buildArea * numFloors;
// if (hasBasement) totalArea += buildArea;

  // 3ï¸âƒ£ Track the grand total
  let grandTotal = 0;

  // 4ï¸âƒ£ Loop through each section
  baseData.forEach(section => {
    let sectionTotal = 0;
    html += `<h3>${section.name}</h3><table><thead><tr>
      <th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
    </tr></thead><tbody>`;

    section.items.forEach(item => {
      // Convert unit string to number (e.g., "100" means base area of 100m2)
      let baseUnitArea = parseFloat(item.unit) || 1;

      // Scale baseQty by ratio of actual totalArea to baseUnitArea
      let adjustedQty = (totalArea / baseUnitArea) * item.baseQty;

      // Calculate item total cost
      let itemTotal = adjustedQty * item.unitPrice;
      sectionTotal += itemTotal;

      html += `<tr>
        <td>${item.item}</td>
        <td>${item.unit}</td>
        <td>${adjustedQty.toFixed(2)}</td>
        <td>${item.unitPrice.toFixed(2)}</td>
        <td>${itemTotal.toFixed(2)}</td>
      </tr>`;
    });

    grandTotal += sectionTotal;

    html += `<tr><td colspan="4"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</strong></td><td><strong>${sectionTotal.toFixed(2)}</strong></td></tr></tbody></table>`;
  });

  // 5ï¸âƒ£ Display grand total
  let grandTotalHtml = `<h2 style="color: red;">ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: ${grandTotal.toFixed(2)}</h2>`;
  document.getElementById('costOutput').innerHTML = grandTotalHtml + html;
  document.getElementById('costOutput').style.display = 'block'; // make sure it's visible
}




    /* ---------- Export / Import ---------- */
    function customStringify(data) {
      const lines = ['['];
      data.forEach((sec, si) => {
        lines.push('  {');
        lines.push(`    "name": ${JSON.stringify(sec.name)},`);
        lines.push('    "items": [');
        (sec.items || []).forEach((it, ii) => {
          const itemObj = {
            item: it.item,
            unit: it.unit,
            unitPrice: it.unitPrice,
            baseQty: it.baseQty
          };
          let itemStr = JSON.stringify(itemObj);
          if (ii < (sec.items || []).length - 1) itemStr += ',';
          lines.push('      ' + itemStr);
        });
        lines.push('    ]');
        lines.push(si < data.length - 1 ? '  },' : '  }');
      });
      lines.push(']');
      return lines.join('\n');
    }

    function exportModel() {
      const blob = new Blob([customStringify(baseData)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'binaa_maghreb_model.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function importModel(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const parsed = JSON.parse(ev.target.result);
          if (!Array.isArray(parsed)) throw new Error('Invalid model file');
          baseData = parsed;
          // Normalize imported data
          baseData.forEach((section, index) => {
            if (!section || !section.name || !Array.isArray(section.items)) {
              console.warn(`Invalid section at index ${index}:`, section);
              section = { name: `Ù‚Ø³Ù… ${index + 1}`, items: [] };
              baseData[index] = section;
            }
            section.items = section.items.map(item => ({
              item: item.item || 'Unknown Item',
              unit: item.unit || '1',
              unitPrice: item.unitPrice !== undefined ? Number(item.unitPrice) : 0,
              baseQty: item.baseQty !== undefined ? Number(item.baseQty) : 0
            }));
          });
          refreshSectionSelects();
          populateItemList();
          loadItemDetails();
          calculateCost();
        } catch (err) {
          alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    /* ---------- PDF / Excel export ---------- */
    function exportToPDF() {
      const element = document.getElementById('costOutput');
      const inputsSummary = `
        <div>
          <h2>Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª</h2>
          <p>Ø·ÙˆÙ„ Ø§Ù„Ù…Ø¨Ù†Ù‰: ${document.getElementById('buildLength').value || 0} Ù…</p>
          <p>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ù†Ù‰: ${document.getElementById('buildWidth').value || 0} Ù…</p>
          <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚: ${document.getElementById('numFloors').value || 0}</p>
          <p>ÙˆØ¬ÙˆØ¯ Ù‚Ø¨Ùˆ: ${document.getElementById('hasBasement').checked ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}</p>
        </div>
      `;
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = inputsSummary + element.outerHTML;
      html2pdf().from(tempDiv).save('cost_estimation.pdf');
    }

    function exportAllToExcel(filename) {
      const wb = XLSX.utils.book_new();
      const detailed = [['Ø§Ù„Ù…Ø±Ø­Ù„Ø©', 'Ø§Ù„Ù…Ø§Ø¯Ø©', 'Ø§Ù„ÙƒÙ…ÙŠØ© (baseQty)', 'Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©', 'Ø§Ù„ØªÙƒÙ„ÙØ©']];
      let grandTotal = 0;

      const numFloors = parseInt(document.getElementById('numFloors').value) || 1;
      const hasBasement = document.getElementById('hasBasement').checked;
      const selectedSections = [];
      if (hasBasement && baseData[0]) selectedSections.push(baseData[0]);
      if (baseData[1]) selectedSections.push(baseData[1]);
      if (numFloors >= 1 && baseData[2]) selectedSections.push(baseData[2]);
      if (numFloors >= 2 && baseData[3]) selectedSections.push(baseData[3]);
      if (baseData[4]) selectedSections.push(baseData[4]);

      let floorArea = parseFloat(document.getElementById('buildLength').value || 0) * parseFloat(document.getElementById('buildWidth').value || 0);

      selectedSections.forEach(sec => {
        let phaseTotal = 0;
        (sec.items || []).forEach(it => {
          if (!it || it.unitPrice === undefined || it.baseQty === undefined) return;
          let baseUnitArea = parseFloat(it.unit) || 1;
          let adjustedQty = (floorArea / baseUnitArea) * it.baseQty;
          const cost = adjustedQty * it.unitPrice;
          phaseTotal += cost;
          grandTotal += cost;
          detailed.push([sec.name, it.item, adjustedQty.toFixed(2), it.unitPrice, cost.toFixed(2)]);
        });
        detailed.push([sec.name, '', '', '', phaseTotal.toFixed(2), 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ']);
      });
      detailed.push(['', '', '', '', grandTotal.toFixed(2), 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ']);

      const ws = XLSX.utils.aoa_to_sheet(detailed);
      XLSX.utils.book_append_sheet(wb, ws, 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ');
      XLSX.writeFile(wb, filename || 'cost_estimation.xlsx');
    }

    /* ---------- Utilities ---------- */
    function logRow(msg) { if (LOG_ENABLED) console.log(msg); }
    function escapeHtml(s) { if (!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c]); }

    /* ---------- Event wiring ---------- */
    document.getElementById('sectionForItem').addEventListener('change', () => {
      populateItemList();
      const itSel = document.getElementById('itemList');
      if (itSel.options.length) itSel.selectedIndex = 0;
      loadItemDetails();
    });
    document.getElementById('itemList').addEventListener('change', loadItemDetails);
    ['buildLength', 'buildWidth', 'numFloors', 'hasBasement'].forEach(id => {
      document.getElementById(id).addEventListener('change', calculateCost);
    });

    /* ---------- Init on load ---------- */
    window.addEventListener('DOMContentLoaded', () => {
      loadDefaultData();
    });
  </script>
</body>
</html>